<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‘ì—…ë³„ ë³´í˜¸êµ¬ ì°©ìš© ì˜·ì…íˆê¸° ê²Œì„</title>
  <style>
    /* === ê¸°ë³¸ ì„¸íŒ… === */
    *{box-sizing:border-box}
    body{margin:0;padding:0;font-family:sans-serif}

    /* í˜ì´ì§€ ê¸°ë³¸Â·í™œì„± í‘œì‹œ */
    .page{display:none;width:100%;padding:20px}
    .page.active{display:block}
    .flex-page.active{display:flex;justify-content:center;align-items:center;min-height:100vh}

    /* ê³µí†µ ì¹´ë“œ */
    .card{
      background:#fff;border-radius:20px;
      box-shadow:0 15px 25px rgba(0,0,0,.1);
      padding:40px;
      width:100%;max-width:600px;margin:0 auto
    }

    /* ë°°ê²½ */
    #page1{background:linear-gradient(135deg,#7b5dff 0%,#4a8dff 100%)}
    #page2{background:radial-gradient(circle at top left,#f3f3f5 0%,#e9e9eb 100%)}
    #page8{background:linear-gradient(135deg,#b6f0e8 0%,#d3ecf6 50%,#ffd6e6 100%)}

    /* ë²„íŠ¼ */
    .button{
      padding:12px 24px;margin:10px;font-size:16px;
      cursor:pointer;color:#fff;border:none;border-radius:8px;
      background:linear-gradient(135deg,#007bff 0%,#0063ff 100%);
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      transition:transform .1s
    }
    .button:hover{transform:translateY(-2px)}
    .restart-button{
      background:linear-gradient(135deg,#6a63ff 0%,#4e45d5 100%);
      color:#fff;border:none;padding:10px 20px;margin:10px;font-size:16px;
      cursor:pointer;border-radius:8px;transition:transform .1s}
    .restart-button:hover{transform:translateY(-2px)}

    /* ë‘¥ê·¼ í…Œë‘ë¦¬ */
    .rounded-border{border:1px solid #000;border-radius:10px}

    /* ===== í˜ì´ì§€ 1 ===== */
    #page1 .card{display:flex;flex-direction:column;align-items:center;text-align:center}
    #page1 h1{margin:0 0 24px 0;word-break:keep-all}  /* ì¢ŒÂ·ìš° ì—¬ë°± ê· í˜• */

    /* ===== í˜ì´ì§€ 2 ===== */
    #page2 .card{text-align:left}
    #page2 .card h2{text-align:center;margin-top:0}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600}
    .form-group input{
      width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;
      font-size:16px
    }
    .blink{color:red;padding:16px;border:1px solid #ffb6b6;background:#ffecec;border-radius:6px}

    /* ===== í˜ì´ì§€ 3~7 ===== */
    .worker-container{position:relative;width:100%;text-align:center}
    .worker-image{width:100%;height:auto;display:block;margin:0 auto}
    .gear-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
    .gear-item img{width:80%;display:block;cursor:pointer;margin:0 auto}

    /* ì ìˆ˜Â·ê¸°íšŒ í‘œì‹œ */
    .score-display,.chances-display{
      position:fixed;right:10px;z-index:1000;min-width:100px;
      padding:10px;border-radius:5px;font-weight:bold;text-align:center}
    .score-display{bottom:60px;background:#f0f0f0;border:1px solid #ccc}
    .chances-display{bottom:10px}
    .cycle-1{background:#e8f5e8!important;border:2px solid #4caf50!important;color:#2e7d32!important}
    .cycle-2{background:#fff3e0!important;border:2px solid #ff9800!important;color:#e65100!important}
    .cycle-3-plus{background:#ffebee!important;border:2px solid #f44336!important;color:#d32f2f!important}

    /* ===== í˜ì´ì§€ 8 ===== */
    #certificate-box{
      border:2px solid #000;padding:20px;margin:20px 0;text-align:center;
      border-radius:12px
    }
    .ranking-table{margin:30px auto 0;border-collapse:collapse;width:100%;max-width:600px}
    .ranking-table th,.ranking-table td{border:1px solid #ddd;padding:8px;text-align:center}
    .ranking-table th{background:#f2f2f2;font-weight:700}
    .ranking-table tr:nth-child(even){background:#f9f9f9}
    .loading{text-align:center;color:#666;font-style:italic}
  </style>
</head>
<body>
  <!-- ì ìˆ˜ / ê¸°íšŒ -->
  <div id="score-display" class="score-display" style="display:none">ì ìˆ˜: <span id="current-score">0</span></div>
  <div id="chances-display" class="chances-display" style="display:none">í´ë¦­ ê¸°íšŒ: <span id="remaining-chances">âˆ</span></div>

  <!-- í˜ì´ì§€ 1 -->
  <div id="page1" class="page flex-page active">
    <div class="card">
      <h1>ì‘ì—…ë³„ ë³´í˜¸êµ¬ ì°©ìš© êµìœ¡</h1>
      <img src="https://i.imgur.com/Tu6mJ5J.png" alt="ë©”ì¸ ì´ë¯¸ì§€">
      <button class="button" id="startButton">êµìœ¡ ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 2 -->
  <div id="page2" class="page flex-page">
    <div class="card">
      <h2 class="center">ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
      <div class="form-group">
        <label for="siteName">í˜„ì¥ëª…</label>
        <input id="siteName" placeholder="í˜„ì¥ëª… ì…ë ¥">
      </div>
      <div class="form-group">
        <label for="workerName">ê·¼ë¡œì ì´ë¦„</label>
        <input id="workerName" placeholder="ì´ë¦„ ì…ë ¥">
      </div>
      <div class="form-group">
        <label for="workerAffiliation">ì†Œì†</label>
        <input id="workerAffiliation" placeholder="ì†Œì† ì…ë ¥">
      </div>
      <div class="blink">
        ì‘ì—… ìƒí™©ì— ë”°ë¥¸ ë³´í˜¸êµ¬ ì°©ìš© ê¸°ì¤€ì„ ì˜·ì…íˆê¸° ê²Œì„ ë°©ì‹ìœ¼ë¡œ í•™ìŠµí•©ë‹ˆë‹¤.<br>
        ê·¼ë¡œì ìºë¦­í„° í•˜ë‹¨ì˜ ë³´í˜¸êµ¬ë¥¼ í´ë¦­í•˜ì—¬ ì˜¬ë°”ë¥¸ ë³´í˜¸êµ¬ë¥¼ ì°©ìš©ì‹œì¼œì£¼ì„¸ìš”.
      </div>
      <button class="button" id="toPage3" style="width:100%">ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 3 -->
  <div id="page3" class="page">
    <h2>ê³ ì†Œì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-3"></div>
    <div id="error-message-3" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-3">
      <button class="button" id="next-button-3" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 4 -->
  <div id="page4" class="page">
    <h2>ìš©ì ‘ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-4"></div>
    <div id="error-message-4" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-4">
      <button class="button" id="next-button-4" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 5 -->
  <div id="page5" class="page">
    <h2>ì •ì „ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-5"></div>
    <div id="error-message-5" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-5">
      <button class="button" id="next-button-5" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 6 -->
  <div id="page6" class="page">
    <h2>ë„ì¥ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-6"></div>
    <div id="error-message-6" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-6">
      <button class="button" id="next-button-6" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 7 -->
  <div id="page7" class="page">
    <h2>ì¼ë°˜ì‘ì—… ê³µí†µì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-7"></div>
    <div id="error-message-7" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-7">
      <button class="button" id="next-button-7" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 8 -->
  <div id="page8" class="page flex-page">
    <div class="card center">
      <div id="certificate-box">
        <h2 style="margin-top:0">ìˆ˜ë£Œì¦</h2>
        <p id="cert-siteName"></p>
        <p id="cert-workerName"></p>
        <p id="cert-workerAffiliation"></p>
        <p>ë³´í˜¸êµ¬ êµìœ¡ì„ ëª¨ë‘ ìˆ˜ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.</p>
      </div>
      <p id="final-score-display" style="margin-top:20px">ìµœì¢… ì ìˆ˜: <span id="final-score">0</span>ì </p>
      <button class="button" id="saveCert">ì €ì¥í•˜ê¸°</button>
      <button class="button" id="homeButton">í™ˆìœ¼ë¡œ</button>
      <h3>ğŸ† ì´ë²ˆ ì£¼ ë­í‚¹</h3>
      <div id="ranking-loading" class="loading">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <table id="ranking-table" class="ranking-table" style="display:none">
        <thead>
          <tr><th>ìˆœìœ„</th><th>ê·¼ë¡œì ì´ë¦„</th><th>í˜„ì¥ëª…</th><th>ì†Œì†</th><th>ì ìˆ˜</th></tr>
        </thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ===== JavaScript : ì „ì²´ ê²Œì„ ë¡œì§ (ëˆ„ë½ ì—†ì´ í¬í•¨) ===== -->
  <script>
    /* ------------------------------------------------------------------
       ê¸°ì¡´ JS ë¡œì§ ê·¸ëŒ€ë¡œ â€” í•œ ê¸€ìë„ ë¹ ì§ì—†ì´ í¬í•¨
    ------------------------------------------------------------------ */

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDqZFIp_jzaUFiNlZxO3AYI3b8H9zDgyW4",
      authDomain: "training-private-equipment.firebaseapp.com",
      projectId: "training-private-equipment",
      storageBucket: "training-private-equipment.firebasestorage.app",
      messagingSenderId: "428074253490",
      appId: "1:428074253490:web:77d4040f8af17338795dab"
    };

    let db=null;
    try{
      if(firebaseConfig.apiKey!=="your-api-key"){
        firebase.initializeApp(firebaseConfig);
        db=firebase.firestore();
      }
    }catch(e){console.log("Firebase ì„¤ì •ì´ ì—†ì–´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");}

    /* ----- ë³´í˜¸êµ¬ ë°ì´í„° Â· ìƒíƒœ ë³€ìˆ˜ ë“± (ë™ì¼) ----- */
    const pageGearData={3:[{id:1,thumbnail:"https://i.imgur.com/yvsCOBF.png",overlay:"https://i.imgur.com/yTJe79p.png",correct:!0,applied:!1,zIndex:1},{id:2,thumbnail:"https://i.imgur.com/8gsL65v.png",overlay:"https://i.imgur.com/zBCjthf.png",correct:!0,applied:!1,zIndex:2},{id:3,thumbnail:"https://i.imgur.com/nvoxlp7.png",overlay:"https://i.imgur.com/VfJMtc3.png",correct:!0,applied:!1,zIndex:3},{id:4,thumbnail:"https://i.imgur.com/m1GZRHc.png",overlay:"https://i.imgur.com/Cphm4b5.png",correct:!0,applied:!1,zIndex:4},{id:5,thumbnail:"https://i.imgur.com/d7Plzcn.png",overlay:"https://i.imgur.com/5VxjKY6.png",correct:!0,applied:!1,zIndex:5},{id:6,thumbnail:"https://i.imgur.com/Ui2tbVv.png",overlay:"",correct:!1,applied:!1,zIndex:6}],4:[{id:1,thumbnail:"https://imgur.com/n6iJRus.png",overlay:"",correct:!1,applied:!1,zIndex:1},{id:2,thumbnail:"https://i.imgur.com/oU1hjTk.png",overlay:"https://i.imgur.com/cPHvWTb.png",correct:!0,applied:!1,zIndex:2},{id:3,thumbnail:"https://i.imgur.com/Ui2tbVv.png",overlay:"https://i.imgur.com/S77YoN3.png",correct:!0,applied:!1,zIndex:4},{id:4,thumbnail:"https://i.imgur.com/Cbcyknu.png",overlay:"https://i.imgur.com/v5kUQPg.png",correct:!0,applied:!1,zIndex:3},{id:5,thumbnail:"https://i.imgur.com/nvoxlp7.png",overlay:"",correct:!1,applied:!1,zIndex:5},{id:6,thumbnail:"https://i.imgur.com/fdH4wzC.png",overlay:"",correct:!1,applied:!1,zIndex:6}],5:[{id:1,thumbnail:"https://i.imgur.com/NnWSEdz.png",overlay:"https://i.imgur.com/ImnVVaf.png",correct:!0,applied:!1,zIndex:1},{id:2,thumbnail:"https://i.imgur.com/NdbXUPl.png",overlay:"https://i.imgur.com/IMelM9Q.png",correct:!0,applied:!1,zIndex:2},{id:3,thumbnail:"https://i.imgur.com/Z5ojhhi.png",overlay:"https://i.imgur.com/3KX2VD4.png",correct:!0,applied:!1,zIndex:3},{id:4,thumbnail:"https://i.imgur.com/Ui2tbVv.png",overlay:"",correct:!1,applied:!1,zIndex:4},{id:5,thumbnail:"https://i.imgur.com/Cbcyknu.png",overlay:"",correct:!1,applied:!1,zIndex:5},{id:6,thumbnail:"https://i.imgur.com/fdH4wzC.png",overlay:"",correct:!1,applied:!1,zIndex:6}],6:[{id:1,thumbnail:"https://i.imgur.com/fdH4wzC.png",overlay:"https://i.imgur.com/fdH4wzC.png",correct:!0,applied:!1,zIndex:1},{id:2,thumbnail:"https://i.imgur.com/yvsCOBF.png",overlay:"https://i.imgur.com/yTJe79p.png",correct:!0,applied:!1,zIndex:2},{id:3,thumbnail:"https://i.imgur.com/F1PF0tE.png",overlay:"https://i.imgur.com/Gctejg5.png",correct:!0,applied:!1,zIndex:3},{id:4,thumbnail:"https://i.imgur.com/n6iJRus.png",overlay:"https://i.imgur.com/oAQe9gI.png",correct:!0,applied:!1,zIndex:4},{id:5,thumbnail:"https://i.imgur.com/d7Plzcn.png",overlay:"https://i.imgur.com/5VxjKY6.png",correct:!0,applied:!1,zIndex:5},{id:6,thumbnail:"https://i.imgur.com/NdbXUPl.png",overlay:"",correct:!1,applied:!1,zIndex:6}],7:[{id:1,thumbnail:"https://i.imgur.com/yvsCOBF.png",overlay:"https://i.imgur.com/yTJe79p.png",correct:!0,applied:!1,zIndex:1},{id:2,thumbnail:"https://i.imgur.com/nvoxlp7.png",overlay:"https://i.imgur.com/VfJMtc3.png",correct:!0,applied:!1,zIndex:2},{id:3,thumbnail:"https://i.imgur.com/d7Plzcn.png",overlay:"https://i.imgur.com/5VxjKY6.png",correct:!0,applied:!1,zIndex:3},{id:4,thumbnail:"https://i.imgur.com/m1GZRHc.png",overlay:"https://i.imgur.com/Cphm4b5.png",correct:!0,applied:!1,zIndex:4},{id:5,thumbnail:"https://i.imgur.com/Cbcyknu.png",overlay:"",correct:!1,applied:!1,zIndex:5},{id:6,thumbnail:"https://i.imgur.com/Ui2tbVv.png",overlay:"",correct:!1,applied:!1,zIndex:6}]};

    let currentScore=0,currentSequenceIndex=0,cycleCount=1,remainingChances=Infinity,hasCompletedFirstCycle=!1,isInRandomCycle=!1,gameSequence=[3,4,5,6,7],maxChancesPerCycle={1:Infinity,2:10,default:5};

    /* ---- ì ìˆ˜Â·ê¸°íšŒ í‘œì‹œ í•¨ìˆ˜ (ë™ì¼) ---- */
    function updateScore(){currentScore++;document.getElementById("current-score").textContent=currentScore}
    function showScore(){document.getElementById("score-display").style.display="block"}
    function hideScore(){document.getElementById("score-display").style.display="none"}
    function updateChances(){const e=document.getElementById("remaining-chances"),t=document.getElementById("chances-display");t.classList.remove("cycle-1","cycle-2","cycle-3-plus"),remainingChances===Infinity?(e.textContent="âˆ",t.classList.add("cycle-1")):2===cycleCount?(e.textContent=Math.max(0,remainingChances),t.classList.add("cycle-2")):(e.textContent=Math.max(0,remainingChances),t.classList.add("cycle-3-plus"))}
    function showChances(){document.getElementById("chances-display").style.display="block",updateChances()}
    function hideChances(){document.getElementById("chances-display").style.display="none"}
    function decreaseChances(){if(remainingChances!==Infinity&&(remainingChances--,updateChances(),remainingChances<0))return setTimeout(()=>{alert(`ğŸ’€ëª¨ë“  ë³´í˜¸êµ¬ë¥¼ ì°©ìš©í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ğŸ’€\ní˜„ì¬ ì ìˆ˜: ${currentScore}ì \nê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.`),goToPage8()},500),!0;return!1}
    function setChancesForCycle(){remainingChances=1===cycleCount?Infinity:2===cycleCount?maxChancesPerCycle[2]:maxChancesPerCycle.default,updateChances()}

    /* ---- í˜ì´ì§€ ì´ë™ ---- */
    document.getElementById("startButton").addEventListener("click",()=>showPage("page2"));
    document.getElementById("toPage3").addEventListener("click",function(){
      if(!document.getElementById("siteName").value.trim()||!document.getElementById("workerName").value.trim()||!document.getElementById("workerAffiliation").value.trim())return alert("í˜„ì¥ëª…, ê·¼ë¡œì ì´ë¦„, ì†Œì†ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      currentScore=0,currentSequenceIndex=0,hasCompletedFirstCycle=!1,isInRandomCycle=!1,gameSequence=[3,4,5,6,7],cycleCount=1;
      for(let e=3;e<=7;e++){const t=document.getElementById(`button-container-${e}`);t&&(t.innerHTML=`<button class="button" id="next-button-${e}" disabled>ë‹¤ìŒ</button>`)}
      document.getElementById("current-score").textContent=currentScore,setChancesForCycle(),showScore(),showChances(),showPage("page3"),initializeGame(3),bindNextButtonEvents()
    });

    function bindNextButtonEvents(){document.querySelectorAll('[id^="next-button-"]').forEach(e=>e.replaceWith(e.cloneNode(!0))),document.getElementById("next-button-3").addEventListener("click",()=>goToNextPage()),document.getElementById("next-button-4").addEventListener("click",()=>goToNextPage()),document.getElementById("next-button-5").addEventListener("click",()=>goToNextPage()),document.getElementById("next-button-6").addEventListener("click",()=>goToNextPage()),document.getElementById("next-button-7").addEventListener("click",()=>goToNextPage())}
    function goToNextPage(){updateScore(),currentSequenceIndex++,currentSequenceIndex>=gameSequence.length?showCycleCompleteButtons(gameSequence[gameSequence.length-1]):(setChancesForCycle(),showPage(`page${gameSequence[currentSequenceIndex]}`),initializeGame(gameSequence[currentSequenceIndex]))}
    function checkGameComplete(e){pageGearData[e].filter(e=>e.correct).every(e=>e.applied)&&(document.getElementById(`next-button-${e}`).disabled=!1,currentSequenceIndex===gameSequence.length-1&&showCycleCompleteButtons(e))}
    function showCycleCompleteButtons(e){const t=document.getElementById(`button-container-${e}`);t&&(t.innerHTML='<button class="button" onclick="goToPage8()">ë‹¤ìŒ</button><button class="restart-button" onclick="startNewRandomCycle()">ë‹¤ì‹œ í•™ìŠµí•˜ê¸°</button>')}
    function goToPage8(){hideScore(),hideChances(),document.getElementById("final-score").textContent=currentScore,document.getElementById("cert-siteName").innerText="í˜„ì¥ëª…: "+document.getElementById("siteName").value,document.getElementById("cert-workerName").innerText="ê·¼ë¡œì ì´ë¦„: "+document.getElementById("workerName").value,document.getElementById("cert-workerAffiliation").innerText="ì†Œì†: "+document.getElementById("workerAffiliation").value,showPage("page8"),saveScoreAndLoadRanking()}
    function startNewRandomCycle(){cycleCount++,isInRandomCycle=!0,gameSequence=shuffle([3,4,5,6,7]),currentSequenceIndex=0;for(let e=3;e<=7;e++){const t=document.getElementById(`button-container-${e}`);t&&(t.innerHTML=`<button class="button" id="next-button-${e}" disabled>ë‹¤ìŒ</button>`)}showPage(`page${gameSequence[0]}`),initializeGame(gameSequence[0]),bindNextButtonEvents()}
    document.getElementById("homeButton").addEventListener("click",()=>location.reload());
    function showPage(e){document.querySelectorAll(".page").forEach(e=>e.classList.remove("active")),document.getElementById(e).classList.add("active")}
    function shuffle(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}
    function initializeGame(e){pageGearData[e].forEach(e=>e.applied=!1);const t=shuffle([...pageGearData[e]]),n=document.getElementById(`gear-grid-${e}`);n.innerHTML="",0===currentSequenceIndex&&setChancesForCycle(),t.forEach(t=>{const r=document.createElement("div");r.className="gear-item";const a=document.createElement("img");a.src=t.thumbnail,a.classList.add("rounded-border"),a.dataset.id=t.id,a.style.pointerEvents="auto",a.style.opacity="1",a.style.cursor="pointer",a.addEventListener("click",()=>handleGearClick(t,a,e)),r.appendChild(a),n.appendChild(r)});const r=document.querySelector(`#page${e} .worker-container`);r.querySelectorAll(".overlay").forEach(e=>e.remove()),document.getElementById(`next-button-${e}`).disabled=!0,document.getElementById(`error-message-${e}`).innerText=""}
    function handleGearClick(e,t,n){if(cycleCount>1&&decreaseChances())return;e.correct?(e.applied?(t.style.opacity=1,e.applied=!1,removeOverlayImage(e,n)):(t.style.opacity=.5,e.applied=!0,addOverlayImage(e,n))):(document.getElementById(`error-message-${n}`).innerText="ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë³´í˜¸êµ¬ì…ë‹ˆë‹¤.",setTimeout(()=>{document.getElementById(`error-message-${n}`).innerText=""},2e3)),checkGameComplete(n)}
    function addOverlayImage(e,t){if(!e.overlay)return;const n=document.querySelector(`#page${t} .worker-container`),r=document.createElement("img");r.src=e.overlay,r.className="overlay",r.dataset.id=e.id,r.style.cssText="position:absolute;top:0;left:0;width:100%;height:100%;z-index:"+e.zIndex,n.appendChild(r)}
    function removeOverlayImage(e,t){const n=document.querySelector(`#page${t} .worker-container img.overlay[data-id="${e.id}"]`);n&&n.remove()}

    /* ---- ë­í‚¹ ì €ì¥Â·í‘œì‹œ (ë™ì¼) ---- */
    async function saveScoreAndLoadRanking(){const e={name:document.getElementById("workerName").value,siteName:document.getElementById("siteName").value,affiliation:document.getElementById("workerAffiliation").value,score:currentScore,timestamp:new Date};try{db?(await saveToFirestore(e),await loadRankingFromFirestore()):(saveToLocalStorage(e),loadRankingFromLocalStorage())}catch(t){console.error("ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:",t),saveToLocalStorage(e),loadRankingFromLocalStorage()}}
    async function saveToFirestore(e){const t=getWeekIdKR(),n=db.collection("rankings").doc(t),r=await n.get();let a=[];r.exists&&(a=r.data().rankings||[]),a.push(e),a.sort((e,t)=>t.score-e.score),a.length>5&&(a=a.slice(0,5)),await n.set({rankings:a})}
    async function loadRankingFromFirestore(){const e=getWeekIdKR(),t=db.collection("rankings").doc(e),n=await t.get();displayRanking(n.exists?n.data().rankings||[]:[])}
    function saveToLocalStorage(e){const t=getWeekIdKR(),n=`rankings_${t}`;let r=JSON.parse(localStorage.getItem(n)||"[]");r.push(e),r.sort((e,t)=>t.score-e.score),r.length>5&&(r=r.slice(0,5)),localStorage.setItem(n,JSON.stringify(r))}
    function loadRankingFromLocalStorage(){const e=getWeekIdKR(),t=`rankings_${e}`,n=JSON.parse(localStorage.getItem(t)||"[]");displayRanking(n)}
    function getWeekIdKR(){const e=new Date,t=new Date(e.getTime()+324e5);t.setDate(t.getDate()-t.getDay()),t.setHours(0,0,0,0);const n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${a}`}
    function displayRanking(e){document.getElementById("ranking-loading").style.display="none",document.getElementById("ranking-table").style.display="table";const t=document.getElementById("ranking-body");t.innerHTML="";for(let n=0;n<5;n++){const r=t.insertRow();if(n<e.length){const t=e[n];r.innerHTML=`<td>${n+1}</td><td>${t.name}</td><td>${t.siteName}</td><td>${t.affiliation}</td><td>${t.score}</td>`}else r.innerHTML=`<td>${n+1}</td><td>-</td><td>-</td><td>-</td><td>-</td>`}}
    /* ---- ìˆ˜ë£Œì¦ ì €ì¥ ---- */
    document.getElementById("saveCert").addEventListener("click",()=>{html2canvas(document.getElementById("certificate-box")).then(e=>{const t=document.createElement("a");t.download="certificate.png",t.href=e.toDataURL(),t.click()})});

    /* ì´ˆê¸° ë°”ì¸ë”© */
    bindNextButtonEvents();
  </script>
</body>
</html>
