<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>작업별 보호구 착용 옷입히기 게임</title>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
    .page { display: none; padding: 20px; }
    .active { display: block; }
    .center { text-align: center; }
    .rounded-border { border: 1px solid black; border-radius: 10px; }
    #page1 img, .worker-image { max-width: 100%; height: auto; display: block; margin: 0 auto; }
    #page2 { text-align: left; }
    .blink { color: red; }
    .worker-container { position: relative; width: 100%; text-align: center; }
    .gear-grid { display: grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:20px; }
    .gear-item img { width:80%; display:block; margin:0 auto; cursor:pointer; }
    .score-display, .chances-display {
      position: fixed; right:10px; padding:10px; border-radius:5px;
      font-weight:bold; z-index:1000; min-width:100px; text-align:center;
      background:#f0f0f0; border:1px solid #ccc;
    }
    .score-display { bottom:60px; }
    .chances-display { bottom:10px; }
    .cycle-1 { background:#e8f5e8!important; border:2px solid #4caf50!important; color:#2e7d32!important; }
    .cycle-2 { background:#fff3e0!important; border:2px solid #ff9800!important; color:#e65100!important; }
    .cycle-3-plus { background:#ffebee!important; border:2px solid #f44336!important; color:#d32f2f!important; }
    #certificate-box { border:2px solid #000; padding:20px; margin:20px 0; text-align:center; }
    .button { padding:10px 20px; margin:10px; font-size:16px; cursor:pointer; }
    .button-group { margin-top:20px; }
    .restart-button {
      background:#4CAF50; color:#fff; border:none; padding:10px 20px; margin:10px;
      font-size:16px; cursor:pointer; border-radius:5px;
    }
    .restart-button:hover { background:#45a049; }
    .ranking-table {
      margin:30px auto 0; border-collapse:collapse; width:100%; max-width:600px;
    }
    .ranking-table th, .ranking-table td { border:1px solid #ddd; padding:8px; text-align:center; }
    .ranking-table th { background:#f2f2f2; }
    .ranking-table tr:nth-child(even) { background:#f9f9f9; }
  </style>
</head>
<body>

  <div id="score-display" class="score-display" style="display:none;">
    점수: <span id="current-score">0</span>
  </div>
  <div id="chances-display" class="chances-display" style="display:none;">
    클릭 기회: <span id="remaining-chances">∞</span>
  </div>

  <!-- 페이지1 -->
  <div id="page1" class="page active">
    <div class="center">
      <h1>작업별 보호구 착용 교육</h1>
      <img src="https://i.imgur.com/Tu6mJ5J.png" alt="메인 이미지">
      <br>
      <button class="button" id="startButton">교육 시작하기</button>
    </div>
  </div>

  <!-- 페이지2 -->
  <div id="page2" class="page">
    <h2>교육 정보 입력</h2>
    <label>현장명:</label><br>
    <input type="text" id="siteName" placeholder="현장명 입력"><br><br>
    <label>근로자 이름:</label><br>
    <input type="text" id="workerName" placeholder="이름 입력"><br><br>
    <label>소속:</label><br>
    <input type="text" id="workerAffiliation" placeholder="소속 입력"><br><br>
    <div class="blink">
      작업 상황에 따른 보호구 착용 기준을 옷입히기 게임 방식으로 학습합니다.
      근로자 캐릭터 하단의 보호구를 클릭하여 올바른 보호구를 착용시켜주세요.
    </div>
    <br>
    <button class="button" id="toPage3">다음</button>
  </div>

  <!-- 페이지3 -->
  <div id="page3" class="page">
    <h2>고소작업시 필수착용 개인보호구</h2>
    <div class="worker-container">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-3"></div>
    <div id="error-message-3" style="color:red;text-align:center;margin-top:10px;"></div>
    <div class="center button-group" id="button-container-3">
      <button class="button" id="next-button-3" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지4 -->
  <div id="page4" class="page">
    <h2>용접작업시 필수착용 개인보호구</h2>
    <div class="worker-container">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-4"></div>
    <div id="error-message-4" style="color:red;text-align:center;margin-top:10px;"></div>
    <div class="center button-group" id="button-container-4">
      <button class="button" id="next-button-4" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지5 -->
  <div id="page5" class="page">
    <h2>정전작업시 필수착용 개인보호구</h2>
    <div class="worker-container">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-5"></div>
    <div id="error-message-5" style="color:red;text-align:center;margin-top:10px;"></div>
    <div class="center button-group" id="button-container-5">
      <button class="button" id="next-button-5" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지6 -->
  <div id="page6" class="page">
    <h2>도장작업시 필수착용 개인보호구</h2>
    <div class="worker-container">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-6"></div>
    <div id="error-message-6" style="color:red;text-align:center;margin-top:10px;"></div>
    <div class="center button-group" id="button-container-6">
      <button class="button" id="next-button-6" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지7 -->
  <div id="page7" class="page">
    <h2>일반작업 공통착용 개인보호구</h2>
    <div class="worker-container">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-7"></div>
    <div id="error-message-7" style="color:red;text-align:center;margin-top:10px;"></div>
    <div class="center button-group" id="button-container-7">
      <button class="button" id="next-button-7" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지8 -->
  <div id="page8" class="page">
    <h2>수료증</h2>
    <div id="certificate-box">
      <p id="cert-siteName"></p>
      <p id="cert-workerName"></p>
      <p id="cert-workerAffiliation"></p>
      <p>보호구 교육을 모두 수료하셨습니다.</p>
    </div>
    <div class="center">
      <button class="button" id="saveCert">저장하기</button>
      <button class="button" id="homeButton">홈으로</button>
      <h3>🏆 이번 주 랭킹</h3>
      <div id="ranking-loading" class="loading">랭킹을 불러오는 중...</div>
      <table id="ranking-table" class="ranking-table" style="display:none;">
        <thead>
          <tr><th>순위</th><th>근로자 이름</th><th>현장명</th><th>소속</th><th>점수</th></tr>
        </thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase & html2canvas SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Firebase 초기화
    const firebaseConfig = { /* 실제 config 삽입 */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 보호구 데이터
    const pageGearData = {
      3: [
        {id:1,thumbnail:'https://i.imgur.com/yvsCOBF.png',overlay:'https://i.imgur.com/yTJe79p.png',correct:true,zIndex:1},
        {id:2,thumbnail:'https://i.imgur.com/8gsL65v.png',overlay:'https://i.imgur.com/zBCjthf.png',correct:true,zIndex:2},
        {id:3,thumbnail:'https://i.imgur.com/nvoxlp7.png',overlay:'https://i.imgur.com/VfJMtc3.png',correct:true,zIndex:3},
        {id:4,thumbnail:'https://i.imgur.com/m1GZRHc.png',overlay:'https://i.imgur.com/Cphm4b5.png',correct:true,zIndex:4},
        {id:5,thumbnail:'https://i.imgur.com/d7Plzcn.png',overlay:'https://i.imgur.com/5VxjKY6.png',correct:true,zIndex:5},
        {id:6,thumbnail:'https://i.imgur.com/Ui2tbVv.png',overlay:'',correct:false,zIndex:6}
      ],
      4: [
        {id:1,thumbnail:'https://imgur.com/n6iJRus.png',overlay:'',correct:false,zIndex:1},
        {id:2,thumbnail:'https://i.imgur.com/oU1hjTk.png',overlay:'https://i.imgur.com/cPHvWTb.png',correct:true,zIndex:2},
        {id:3,thumbnail:'https://i.imgur.com/Ui2tbVv.png',overlay:'https://i.imgur.com/S77YoN3.png',correct:true,zIndex:4},
        {id:4,thumbnail:'https://i.imgur.com/Cbcyknu.png',overlay:'https://i.imgur.com/v5kUQPg.png',correct:true,zIndex:3},
        {id:5,thumbnail:'https://i.imgur.com/nvoxlp7.png',overlay:'',correct:false,zIndex:5},
        {id:6,thumbnail:'https://i.imgur.com/fdH4wzC.png',overlay:'',correct:false,zIndex:6}
      ],
      5: [
        {id:1,thumbnail:'https://i.imgur.com/NnWSEdz.png',overlay:'https://i.imgur.com/ImnVVaf.png',correct:true,zIndex:1},
        {id:2,thumbnail:'https://i.imgur.com/NdbXUPl.png',overlay:'https://i.imgur.com/IMelM9Q.png',correct:true,zIndex:2},
        {id:3,thumbnail:'https://i.imgur.com/Z5ojhhi.png',overlay:'https://i.imgur.com/3KX2VD4.png',correct:true,zIndex:3},
        {id:4,thumbnail:'https://i.imgur.com/Ui2tbVv.png',overlay:'',correct:false,zIndex:4},
        {id:5,thumbnail:'https://i.imgur.com/Cbcyknu.png',overlay:'',correct:false,zIndex:5},
        {id:6,thumbnail:'https://i.imgur.com/fdH4wzC.png',overlay:'',correct:false,zIndex:6}
      ],
      6: [
        {id:1,thumbnail:'https://i.imgur.com/fdH4wzC.png',overlay:'https://i.imgur.com/fdH4wzC.png',correct:true,zIndex:1},
        {id:2,thumbnail:'https://i.imgur.com/yvsCOBF.png',overlay:'https://i.imgur.com/yTJe79p.png',correct:true,zIndex:2},
        {id:3,thumbnail:'https://i.imgur.com/F1PF0tE.png',overlay:'https://i.imgur.com/Gctejg5.png',correct:true,zIndex:3},
        {id:4,thumbnail:'https://i.imgur.com/n6iJRus.png',overlay:'https://i.imgur.com/oAQe9gI.png',correct:true,zIndex:4},
        {id:5,thumbnail:'https://i.imgur.com/d7Plzcn.png',overlay:'https://i.imgur.com/5VxjKY6.png',correct:true,zIndex:5},
        {id:6,thumbnail:'https://i.imgur.com/NdbXUPl.png',overlay:'',correct:false,zIndex:6}
      ],
      7: [
        {id:1,thumbnail:'https://i.imgur.com/yvsCOBF.png',overlay:'https://i.imgur.com/yTJe79p.png',correct:true,zIndex:1},
        {id:2,thumbnail:'https://i.imgur.com/nvoxlp7.png',overlay:'https://i.imgur.com/VfJMtc3.png',correct:true,zIndex:2},
        {id:3,thumbnail:'https://i.imgur.com/d7Plzcn.png',overlay:'https://i.imgur.com/5VxjKY6.png',correct:true,zIndex:3},
        {id:4,thumbnail:'https://i.imgur.com/m1GZRHc.png',overlay:'https://i.imgur.com/Cphm4b5.png',correct:true,zIndex:4},
        {id:5,thumbnail:'https://i.imgur.com/Cbcyknu.png',overlay:'',correct:false,zIndex:5},
        {id:6,thumbnail:'https://i.imgur.com/Ui2tbVv.png',overlay:'',correct:false,zIndex:6}
      ]
    };

    // 게임 상태
    let currentScore = 0;
    let gameSequence = [3,4,5,6,7];
    let currentIndex = 0;
    let cycleCount = 1;
    let remainingChances = Infinity;
    const maxChances = {1:Infinity,2:10,default:5};

    // 헬퍼
    const shuffle = arr => arr.sort(()=>Math.random()-0.5);
    const showPage = id => {
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    };
    const updateScoreDisplay = () => document.getElementById('current-score').textContent = currentScore;
    const updateChancesDisplay = () => {
      const el = document.getElementById('remaining-chances');
      const disp = document.getElementById('chances-display');
      disp.classList.remove('cycle-1','cycle-2','cycle-3-plus');
      if(remainingChances===Infinity){
        el.textContent='∞'; disp.classList.add('cycle-1');
      } else if(cycleCount===2){
        el.textContent=Math.max(0,remainingChances); disp.classList.add('cycle-2');
      } else {
        el.textContent=Math.max(0,remainingChances); disp.classList.add('cycle-3-plus');
      }
    };
    const setChances = () => {
      remainingChances = cycleCount===1 ? Infinity
                       : cycleCount===2 ? maxChances[2]
                       : maxChances.default;
      updateChancesDisplay();
    };
    const decreaseChances = () => {
      if(remainingChances!==Infinity){
        remainingChances--; updateChancesDisplay();
        if(remainingChances<0){
          setTimeout(()=>{
            alert(`💀 보호구 착용 실패 💀\n최종 점수: ${currentScore}`);
            goToPage8();
          },500);
          return true;
        }
      }
      return false;
    };

    // 버튼 바인딩
    document.getElementById('startButton').addEventListener('click', ()=> showPage('page2'));
    document.getElementById('toPage3').addEventListener('click', ()=>{
      if(!siteName.value.trim()||!workerName.value.trim()||!workerAffiliation.value.trim()){
        alert('현장명·이름·소속을 모두 입력하세요.');
        return;
      }
      currentScore=0; currentIndex=0; cycleCount=1;
      updateScoreDisplay(); setChances();
      document.getElementById('score-display').style.display='block';
      document.getElementById('chances-display').style.display='block';
      for(let n of [3,4,5,6,7]){
        const bc = document.getElementById(`button-container-${n}`);
        bc.innerHTML = `<button class="button" id="next-button-${n}" disabled>다음</button>`;
      }
      bindNext();
      showPage('page3');
      initPage(3);
    });

    function bindNext(){
      [3,4,5,6,7].forEach(n=>{
        const btn = document.getElementById(`next-button-${n}`);
        btn.addEventListener('click', ()=> {
          currentScore++; updateScoreDisplay();
          if(decreaseChances()) return;
          currentIndex++;
          if(currentIndex>=gameSequence.length){
            showCycleButtons(gameSequence.slice(-1)[0]);
          } else {
            const next = gameSequence[currentIndex];
            setChances();
            showPage(`page${next}`);
            initPage(next);
          }
        });
      });
    }

    function showCycleButtons(pageNum){
      const bc = document.getElementById(`button-container-${pageNum}`);
      bc.innerHTML = `
        <button class="button" onclick="goToPage8()">다음</button>
        <button class="restart-button" onclick="restartCycle()">다시 학습하기</button>
      `;
    }
    window.restartCycle = ()=>{
      cycleCount++; currentIndex=0;
      gameSequence = shuffle([3,4,5,6,7]);
      setChances();
      for(let n of [3,4,5,6,7]){
        const bc = document.getElementById(`button-container-${n}`);
        bc.innerHTML = `<button class="button" id="next-button-${n}" disabled>다음</button>`;
      }
      bindNext();
      showPage(`page${gameSequence[0]}`);
      initPage(gameSequence[0]);
    };

    function initPage(pageNum){
      const grid = document.getElementById(`gear-grid-${pageNum}`);
      grid.innerHTML = '';
      shuffle(pageGearData[pageNum]).forEach(item=>{
        const div = document.createElement('div'), img=document.createElement('img');
        img.src=item.thumbnail; img.className='rounded-border';
        img.dataset.id=item.id; img.style.cursor='pointer';
        img.addEventListener('click', ()=>{
          if(cycleCount>1 && decreaseChances()) return;
          if(item.correct){
            item.applied = !item.applied;
            img.style.opacity = item.applied ? '0.5' : '1';
            item.applied ? addOverlay(item,pageNum) : removeOverlay(item,pageNum);
          } else {
            const em = document.getElementById(`error-message-${pageNum}`);
            em.textContent='올바르지 않은 보호구입니다.';
            setTimeout(()=>em.textContent='',2000);
          }
          checkComplete(pageNum);
        });
        div.className='gear-item'; div.appendChild(img);
        grid.appendChild(div);
      });
      // 초기 상태
      document.querySelectorAll(`#page${pageNum} .overlay`).forEach(o=>o.remove());
      document.getElementById(`next-button-${pageNum}`).disabled = true;
      setChances();
    }

    function addOverlay(item,pageNum){
      if(!item.overlay) return;
      const wc = document.querySelector(`#page${pageNum} .worker-container`);
      const ov = document.createElement('img');
      ov.src=item.overlay; ov.className='overlay';
      ov.style.position='absolute'; ov.style.top='0'; ov.style.left='0';
      ov.style.width='100%'; ov.style.height='100%'; ov.style.zIndex=item.zIndex;
      wc.appendChild(ov);
    }
    function removeOverlay(item,pageNum){
      const wc = document.querySelector(`#page${pageNum} .worker-container`);
      const ov = wc.querySelector(`img.overlay[src="${item.overlay}"]`);
      if(ov) ov.remove();
    }
    function checkComplete(pageNum){
      const all = pageGearData[pageNum]
        .filter(i=>i.correct).every(i=>i.applied);
      document.getElementById(`next-button-${pageNum}`).disabled = !all;
      if(all && currentIndex===gameSequence.length-1){
        showCycleButtons(pageNum);
      }
    }

    window.goToPage8 = ()=>{
      document.getElementById('score-display').style.display='none';
      document.getElementById('chances-display').style.display='none';
      document.getElementById('cert-siteName').textContent = `현장명: ${siteName.value}`;
      document.getElementById('cert-workerName').textContent = `근로자 이름: ${workerName.value}`;
      document.getElementById('cert-workerAffiliation').textContent = `소속: ${workerAffiliation.value}`;
      showPage('page8');
      // ranking 로직...
    };

    document.getElementById('homeButton').addEventListener('click', ()=>location.reload());
    document.getElementById('saveCert').addEventListener('click', ()=>{
      html2canvas(document.getElementById('certificate-box')).then(canvas=>{
        const a=document.createElement('a');
        a.href=canvas.toDataURL(); a.download='certificate.png'; a.click();
      });
    });

  }); // DOMContentLoaded
  </script>
</body>
</html>
