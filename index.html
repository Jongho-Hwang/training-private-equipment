<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>작업별 보호구 착용 옷입히기 게임</title>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    .page { display: none; padding: 20px; }
    .active { display: block; }
    .center { text-align: center; }
    /* 얇은 검정색 둥근 테두리 (애플 아이콘 스타일) */
    .rounded-border {
      border: 1px solid black;
      border-radius: 10px;
    }
    /* 페이지1 스타일 */
    #page1 img { max-width: 100%; height: auto; }
    /* 페이지2 스타일 */
    #page2 { text-align: left; }
    .blink { color: red; }
    /* 페이지3-7 스타일 */
    .worker-container {
      position: relative;
      width: 100%;
      text-align: center;
    }
    /* 근로자 이미지는 컨테이너 폭에 맞게 100%로 표시 */
    .worker-image {
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    /* 보호구 그리드 */
    .gear-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .gear-item {
      width: 100%;
      position: relative;
    }
    /* 보호구 썸네일: 80% 크기로 축소, 중앙 정렬, 둥근 테두리 적용 */
    .gear-item img {
      width: 80%;
      display: block;
      cursor: pointer;
      margin: 0 auto;
    }
    /* 점수 표시 - 우측 하단 */
    .score-display {
      position: fixed;
      bottom: 60px;
      right: 10px;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-weight: bold;
      z-index: 1000;
      min-width: 100px;
      text-align: center;
    }
    /* 기회 표시 - 우측 하단 (점수 위) */
    .chances-display {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      min-width: 100px;
      text-align: center;
    }
    /* 첫 사이클: 무제한 (초록색) */
    .cycle-1 {
      background: #e8f5e8 !important;
      border: 2px solid #4caf50 !important;
      color: #2e7d32 !important;
    }
    /* 두 번째 사이클: 10번 기회 (주황색) */
    .cycle-2 {
      background: #fff3e0 !important;
      border: 2px solid #ff9800 !important;
      color: #e65100 !important;
    }
    /* 세 번째 사이클 이후: 5번 기회 (빨간색) */
    .cycle-3-plus {
      background: #ffebee !important;
      border: 2px solid #f44336 !important;
      color: #d32f2f !important;
    }
    /* 페이지8 스타일 */
    #certificate-box {
      border: 2px solid #000;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    .button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    /* 랭킹 테이블 스타일 */
    .ranking-table {
      margin-top: 30px;
      border-collapse: collapse;
      width: 100%;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .ranking-table th, .ranking-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .ranking-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .ranking-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
    /* 버튼 그룹 스타일 */
    .button-group {
      margin-top: 20px;
    }
    .restart-button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }
    .restart-button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <!-- 점수 표시 (페이지 3-7에서만 표시) -->
  <div id="score-display" class="score-display" style="display: none;">
    점수: <span id="current-score">0</span>
  </div>

  <!-- 기회 표시 (페이지 3-7에서만 표시) -->
  <div id="chances-display" class="chances-display" style="display: none;">
    클릭 기회: <span id="remaining-chances">∞</span>
  </div>

  <!-- 페이지1: 시작 화면 -->
  <div id="page1" class="page active">
    <div class="center">
      <h1>작업별 보호구 착용 교육</h1>
      <img src="https://i.imgur.com/Tu6mJ5J.png" alt="메인 이미지">
      <br>
      <button class="button" id="startButton">교육 시작하기</button>
    </div>
  </div>

  <!-- 페이지2: 교육 정보 입력 -->
  <div id="page2" class="page">
    <h2>교육 정보 입력</h2>
    <label>현장명:</label><br>
    <input type="text" id="siteName" placeholder="현장명 입력"><br><br>
    <label>근로자 이름:</label><br>
    <input type="text" id="workerName" placeholder="이름 입력"><br><br>
    <label>소속:</label><br>
    <input type="text" id="workerAffiliation" placeholder="소속 입력"><br><br>
    <div class="blink">작업 상황에 따른 보호구 착용 기준을 옷입히기 게임 방식으로 학습합니다. 근로자 캐릭터 하단의 보호구를 클릭하여 올바른 보호구를 착용시켜주세요.</div>
    <br>
    <button class="button" id="toPage3">다음</button>
  </div>

  <!-- 페이지3: 고소작업시 필수착용 개인보호구 -->
  <div id="page3" class="page">
    <h2>고소작업시 필수착용 개인보호구</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-3"></div>
    <div id="error-message-3" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-3">
      <button class="button" id="next-button-3" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지4: 용접작업시 필수착용 개인보호구 -->
  <div id="page4" class="page">
    <h2>용접작업시 필수착용 개인보호구</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-4"></div>
    <div id="error-message-4" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-4">
      <button class="button" id="next-button-4" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지5: 정전작업시 필수착용 개인보호구 -->
  <div id="page5" class="page">
    <h2>정전작업시 필수착용 개인보호구</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-5"></div>
    <div id="error-message-5" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-5">
      <button class="button" id="next-button-5" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지6: 도장작업시 필수착용 개인보호구 -->
  <div id="page6" class="page">
    <h2>도장작업시 필수착용 개인보호구</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-6"></div>
    <div id="error-message-6" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-6">
      <button class="button" id="next-button-6" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지7: 일반작업 공통착용 개인보호구 -->
  <div id="page7" class="page">
    <h2>일반작업 공통착용 개인보호구</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="근로자 이미지">
    </div>
    <div class="gear-grid" id="gear-grid-7"></div>
    <div id="error-message-7" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-7">
      <button class="button" id="next-button-7" disabled>다음</button>
    </div>
  </div>

  <!-- 페이지8: 수료증 화면 -->
  <div id="page8" class="page">
    <h2>수료증</h2>
    <div id="certificate-box">
      <p id="cert-siteName"></p>
      <p id="cert-workerName"></p>
      <p id="cert-workerAffiliation"></p>
      <p id="final-score-display">최종 점수: <span id="final-score">0</span>점</p>
      <p>보호구 교육을 모두 수료하셨습니다.</p>
    </div>
    <div style="text-align: center;">
      <p>관리자에게 수료증 화면을 보여주세요</p>
      <button class="button" id="saveCert">저장하기</button>
      <button class="button" id="homeButton">홈으로</button>
      
      <h3>🏆 이번 주 랭킹</h3>
      <div id="ranking-loading" class="loading">랭킹을 불러오는 중...</div>
      <table id="ranking-table" class="ranking-table" style="display: none;">
        <thead>
          <tr>
            <th>순위</th>
            <th>근로자 이름</th>
            <th>현장명</th>
            <th>소속</th>
            <th>점수</th>
          </tr>
        </thead>
        <tbody id="ranking-body">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- html2canvas (수료증 캡쳐용) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Firebase 설정 - 실제 프로젝트 설정 적용됨
    const firebaseConfig = {
      apiKey: "AIzaSyDqZFIp_jzaUFiNlZxO3AYI3b8H9zDgyW4",
      authDomain: "training-private-equipment.firebaseapp.com",
      projectId: "training-private-equipment",
      storageBucket: "training-private-equipment.firebasestorage.app",
      messagingSenderId: "428074253490",
      appId: "1:428074253490:web:77d4040f8af17338795dab"
    };

    // Firebase 초기화 (설정이 없으면 로컬 스토리지 사용)
    let db = null;
    try {
      if (firebaseConfig.apiKey !== "your-api-key") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
      }
    } catch (error) {
      console.log("Firebase 설정이 없어 로컬 스토리지를 사용합니다.");
    }

    // 각 페이지별 보호구 데이터
    const pageGearData = {
      3: [
        { id: 1, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/8gsL65v.png', overlay: 'https://i.imgur.com/zBCjthf.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: 'https://i.imgur.com/VfJMtc3.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/m1GZRHc.png', overlay: 'https://i.imgur.com/Cphm4b5.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      4: [
        { id: 1, thumbnail: 'https://imgur.com/n6iJRus.png', overlay: '', correct: false, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/oU1hjTk.png', overlay: 'https://i.imgur.com/cPHvWTb.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: 'https://i.imgur.com/S77YoN3.png', correct: true, applied: false, zIndex: 4 },
        { id: 4, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: 'https://i.imgur.com/v5kUQPg.png', correct: true, applied: false, zIndex: 3 },
        { id: 5, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      5: [
        { id: 1, thumbnail: 'https://i.imgur.com/NnWSEdz.png', overlay: 'https://i.imgur.com/ImnVVaf.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/NdbXUPl.png', overlay: 'https://i.imgur.com/IMelM9Q.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/Z5ojhhi.png', overlay: 'https://i.imgur.com/3KX2VD4.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      6: [
        { id: 1, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: 'https://i.imgur.com/fdH4wzC.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/F1PF0tE.png', overlay: 'https://i.imgur.com/Gctejg5.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/n6iJRus.png', overlay: 'https://i.imgur.com/oAQe9gI.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/NdbXUPl.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      7: [
        { id: 1, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: 'https://i.imgur.com/VfJMtc3.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/m1GZRHc.png', overlay: 'https://i.imgur.com/Cphm4b5.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ]
    };

    // 게임 상태 변수
    let currentScore = 0;
    let gameSequence = [3, 4, 5, 6, 7]; // 기본 페이지 순서
    let currentSequenceIndex = 0;
    let hasCompletedFirstCycle = false;
    let isInRandomCycle = false;
    let cycleCount = 1; // 현재 사이클 횟수
    let remainingChances = Infinity; // 남은 기회
    let maxChancesPerCycle = {
      1: Infinity, // 첫 번째 사이클: 무제한
      2: 10,       // 두 번째 사이클: 10번
      default: 5   // 세 번째 사이클 이후: 5번
    };

    // 점수 업데이트 함수
    function updateScore() {
      currentScore += 1;
      document.getElementById('current-score').textContent = currentScore;
    }

    // 점수 표시/숨김
    function showScore() {
      document.getElementById('score-display').style.display = 'block';
    }

    function hideScore() {
      document.getElementById('score-display').style.display = 'none';
    }

    // 기회 업데이트 함수
    function updateChances() {
      const chancesElement = document.getElementById('remaining-chances');
      const chancesDisplay = document.getElementById('chances-display');
      
      // 기존 클래스 제거
      chancesDisplay.classList.remove('cycle-1', 'cycle-2', 'cycle-3-plus');
      
      if (remainingChances === Infinity) {
        chancesElement.textContent = '∞';
        chancesDisplay.classList.add('cycle-1'); // 초록색
      } else if (cycleCount === 2) {
        chancesElement.textContent = Math.max(0, remainingChances); // 0 이하일 때는 0으로 표시
        chancesDisplay.classList.add('cycle-2'); // 주황색
      } else {
        chancesElement.textContent = Math.max(0, remainingChances); // 0 이하일 때는 0으로 표시
        chancesDisplay.classList.add('cycle-3-plus'); // 빨간색
      }
    }

    // 기회 표시/숨김
    function showChances() {
      document.getElementById('chances-display').style.display = 'block';
      updateChances();
    }

    function hideChances() {
      document.getElementById('chances-display').style.display = 'none';
    }

    // 기회 차감
    function decreaseChances() {
      if (remainingChances !== Infinity) {
        remainingChances--;
        updateChances();
        
        console.log(`🎯 기회 차감: ${remainingChances} 남음 (사이클 ${cycleCount})`);
        
        if (remainingChances < 0) {
          // 허용된 클릭 수를 초과한 경우 게임 종료
          console.log('💀 보호구를 모두 착용하지 못했습니다!');
          setTimeout(() => {
            if (cycleCount === 2) {
              alert(`보호구를 모두 착용하지 못했습니다!\n현재 점수: ${currentScore}점\n게임이 종료됩니다.`);
            } else {
              alert(`보호구를 모두 착용하지 못했습니다!\n현재 점수: ${currentScore}점\n게임이 종료됩니다.`);
            }
            goToPage8();
          }, 500);
          return true; // 게임 종료됨
        }
      }
      return false; // 게임 계속
    }

    // 사이클별 기회 설정
    function setChancesForCycle() {
      if (cycleCount === 1) {
        remainingChances = Infinity;
        console.log(`🟢 사이클 ${cycleCount}: 무제한 기회 설정`);
      } else if (cycleCount === 2) {
        remainingChances = maxChancesPerCycle[2];
        console.log(`🟡 사이클 ${cycleCount}: ${remainingChances}번 기회 설정`);
      } else {
        remainingChances = maxChancesPerCycle.default;
        console.log(`🔴 사이클 ${cycleCount}: ${remainingChances}번 기회 설정`);
      }
      updateChances();
    }

    // 페이지 전환 이벤트
    document.getElementById('startButton').addEventListener('click', function() {
      showPage('page2');
    });

    document.getElementById('toPage3').addEventListener('click', function() {
      if(document.getElementById('siteName').value.trim() === '' || 
         document.getElementById('workerName').value.trim() === '' || 
         document.getElementById('workerAffiliation').value.trim() === '') {
        alert('현장명, 근로자 이름, 소속을 모두 입력해주세요.');
        return;
      }
      
      // 게임 완전 초기화
      currentScore = 0;
      currentSequenceIndex = 0;
      hasCompletedFirstCycle = false;
      isInRandomCycle = false;
      gameSequence = [3, 4, 5, 6, 7];
      cycleCount = 1; // 첫 번째 사이클로 명시적 초기화
      
      console.log('🎮 게임 시작 - 첫 번째 사이클 (무제한 기회)');
      
      // 모든 페이지의 버튼을 기본 상태로 초기화
      for (let i = 3; i <= 7; i++) {
        const buttonContainer = document.getElementById(`button-container-${i}`);
        if (buttonContainer) {
          buttonContainer.innerHTML = `<button class="button" id="next-button-${i}" disabled>다음</button>`;
        }
      }
      
      document.getElementById('current-score').textContent = currentScore;
      setChancesForCycle(); // 첫 사이클 기회 설정 (무제한)
      showScore();
      showChances();
      showPage('page3');
      initializeGame(3);
      
      // 이벤트 리스너 다시 바인딩
      bindNextButtonEvents();
    });

    // 다음 버튼 이벤트 바인딩 함수
    function bindNextButtonEvents() {
      // 기존 이벤트 리스너 제거
      document.querySelectorAll('[id^="next-button-"]').forEach(button => {
        button.replaceWith(button.cloneNode(true));
      });

      // 새로운 이벤트 리스너 추가
      document.getElementById('next-button-3').addEventListener('click', () => goToNextPage());
      document.getElementById('next-button-4').addEventListener('click', () => goToNextPage());
      document.getElementById('next-button-5').addEventListener('click', () => goToNextPage());
      document.getElementById('next-button-6').addEventListener('click', () => goToNextPage());
      document.getElementById('next-button-7').addEventListener('click', () => goToNextPage());
    }

    // 다음 페이지로 이동
    function goToNextPage() {
      updateScore();
      currentSequenceIndex++;

      if (currentSequenceIndex >= gameSequence.length) {
        // 사이클 완료
        if (cycleCount === 1) {
          // 첫 번째 사이클 완료
          hasCompletedFirstCycle = true;
          // 사이클 완료 버튼 표시 (아직 cycleCount는 증가시키지 않음)
          showCycleCompleteButtons(gameSequence[gameSequence.length - 1]);
        } else {
          // 두 번째 사이클 이후 완료
          showCycleCompleteButtons(gameSequence[gameSequence.length - 1]);
        }
        return;
      }

      const nextPageNum = gameSequence[currentSequenceIndex];
      
      // 🔄 페이지 이동 시 기회 초기화
      setChancesForCycle();
      console.log(`📄 페이지 ${nextPageNum}로 이동 - 기회 초기화: ${remainingChances}`);
      
      showPage(`page${nextPageNum}`);
      initializeGame(nextPageNum);
    }

    // 게임 완료 체크 (보호구를 모두 착용했을 때 호출)
    function checkGameComplete(pageNum) {
      const gearItems = pageGearData[pageNum];
      const allApplied = gearItems.filter(item => item.correct).every(item => item.applied);
      
      const nextButton = document.getElementById(`next-button-${pageNum}`);
      if (nextButton) nextButton.disabled = !allApplied;
      
      // 모든 보호구를 착용했고, 이것이 사이클의 마지막 페이지인 경우
      if (allApplied && currentSequenceIndex === gameSequence.length - 1) {
        // 첫 번째 사이클이거나 이미 첫 사이클을 완료한 경우
        if (cycleCount === 1 || hasCompletedFirstCycle) {
          showCycleCompleteButtons(pageNum);
        }
      }
    }

    // 사이클 완료 시 버튼 표시
    function showCycleCompleteButtons(pageNum) {
      const buttonContainer = document.getElementById(`button-container-${pageNum}`);
      
      if (buttonContainer) {
        buttonContainer.innerHTML = `
          <button class="button" onclick="goToPage8()">다음</button>
          <button class="restart-button" onclick="startNewRandomCycle()">다시 학습하기</button>
        `;
      }
    }

    // 페이지8로 이동
    function goToPage8() {
      hideScore();
      hideChances();
      document.getElementById('final-score').textContent = currentScore;
      document.getElementById('cert-siteName').innerText = "현장명: " + document.getElementById('siteName').value;
      document.getElementById('cert-workerName').innerText = "근로자 이름: " + document.getElementById('workerName').value;
      document.getElementById('cert-workerAffiliation').innerText = "소속: " + document.getElementById('workerAffiliation').value;
      showPage('page8');
      saveScoreAndLoadRanking();
    }

    // 새로운 랜덤 사이클 시작
    function startNewRandomCycle() {
      // 사이클 카운트 증가
      cycleCount++;
      console.log(`🔄 새로운 사이클 시작: ${cycleCount}`);
      
      isInRandomCycle = true;
      gameSequence = shuffle([3, 4, 5, 6, 7]);
      currentSequenceIndex = 0;
      
      console.log(`📊 사이클 ${cycleCount} 시작 - 순서: [${gameSequence.join(',')}]`);
      
      // 모든 페이지의 버튼을 기본 상태로 초기화
      for (let i = 3; i <= 7; i++) {
        const buttonContainer = document.getElementById(`button-container-${i}`);
        if (buttonContainer) {
          buttonContainer.innerHTML = `<button class="button" id="next-button-${i}" disabled>다음</button>`;
        }
      }
      
      const firstPageNum = gameSequence[0];
      showPage(`page${firstPageNum}`);
      initializeGame(firstPageNum); // 여기서 기회 설정됨
      
      // 이벤트 리스너 다시 바인딩
      bindNextButtonEvents();
    }

    document.getElementById('homeButton').addEventListener('click', function() {
      location.reload();
    });

    // 지정한 페이지 표시
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(function(page) {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function initializeGame(pageNum) {
      const gearItems = pageGearData[pageNum];
      gearItems.forEach(item => item.applied = false);
      const shuffledItems = shuffle([...gearItems]);
      const gearGrid = document.getElementById(`gear-grid-${pageNum}`);
      gearGrid.innerHTML = '';
      
      // 🔄 첫 페이지인 경우에만 기회 설정 (다른 페이지는 goToNextPage에서 이미 처리됨)
      if (currentSequenceIndex === 0) {
        setChancesForCycle();
        console.log(`🎮 첫 페이지 ${pageNum} 시작 - 기회: ${remainingChances}`);
      }
      
      shuffledItems.forEach(item => {
        const gearDiv = document.createElement('div');
        gearDiv.className = 'gear-item';
        const img = document.createElement('img');
        img.src = item.thumbnail;
        img.classList.add('rounded-border');
        img.dataset.id = item.id;
        
        // 클릭 항상 활성화 (기회가 있는 경우에만)
        img.style.pointerEvents = 'auto';
        img.style.opacity = '1';
        img.style.cursor = 'pointer';
        
        img.addEventListener('click', function() {
          handleGearClick(item, img, pageNum);
        });
        
        gearDiv.appendChild(img);
        gearGrid.appendChild(gearDiv);
      });
      
      // 기존 오버레이 제거
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      workerContainer.querySelectorAll('.overlay').forEach(overlay => overlay.remove());
      
      // 다음 버튼 비활성화
      const nextButton = document.getElementById(`next-button-${pageNum}`);
      if (nextButton) nextButton.disabled = true;
      
      document.getElementById(`error-message-${pageNum}`).innerText = '';
      
      console.log(`🎯 페이지 ${pageNum} 초기화 완료 (사이클 ${cycleCount}, 기회: ${remainingChances})`);
    }

    function handleGearClick(item, imgElement, pageNum) {
      console.log(`👆 보호구 클릭: ${item.correct ? '올바름' : '틀림'} (사이클 ${cycleCount})`);
      
      // 첫 번째 사이클이 아닌 경우에만 기회 차감
      if (cycleCount > 1) {
        const gameEnded = decreaseChances();
        if (gameEnded) {
          return; // 게임이 종료된 경우 더 이상 진행하지 않음
        }
      }

      if(item.correct) {
        if(!item.applied) {
          imgElement.style.opacity = 0.5;
          item.applied = true;
          addOverlayImage(item, pageNum);
        } else {
          imgElement.style.opacity = 1;
          item.applied = false;
          removeOverlayImage(item, pageNum);
        }
      } else {
        document.getElementById(`error-message-${pageNum}`).innerText = '올바르지 않은 보호구입니다.';
        setTimeout(() => {
          document.getElementById(`error-message-${pageNum}`).innerText = '';
        }, 2000);
      }
      checkAllCorrectApplied(pageNum);
    }

    function addOverlayImage(item, pageNum) {
      if(!item.overlay) return;
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      const overlayImg = document.createElement('img');
      overlayImg.src = item.overlay;
      overlayImg.className = 'overlay';
      overlayImg.dataset.id = item.id;
      overlayImg.style.position = 'absolute';
      overlayImg.style.top = '0';
      overlayImg.style.left = '0';
      overlayImg.style.width = '100%';
      overlayImg.style.height = '100%';
      overlayImg.style.zIndex = item.zIndex;
      workerContainer.appendChild(overlayImg);
    }

    function removeOverlayImage(item, pageNum) {
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      const overlay = workerContainer.querySelector(`img.overlay[data-id="${item.id}"]`);
      if(overlay) overlay.remove();
    }

    function checkAllCorrectApplied(pageNum) {
      checkGameComplete(pageNum);
    }

    // 점수 저장 및 랭킹 로드
    async function saveScoreAndLoadRanking() {
      const playerData = {
        name: document.getElementById('workerName').value,
        siteName: document.getElementById('siteName').value,
        affiliation: document.getElementById('workerAffiliation').value,
        score: currentScore,
        timestamp: new Date()
      };

      try {
        if (db) {
          // Firestore 사용
          await saveToFirestore(playerData);
          await loadRankingFromFirestore();
        } else {
          // 로컬 스토리지 사용
          saveToLocalStorage(playerData);
          loadRankingFromLocalStorage();
        }
      } catch (error) {
        console.error('점수 저장 실패:', error);
        // Firestore 실패시 로컬 스토리지로 fallback
        saveToLocalStorage(playerData);
        loadRankingFromLocalStorage();
      }
    }

    // Firestore에 저장
    async function saveToFirestore(playerData) {
      const weekId = getKoreanWeekId();
      const rankingRef = db.collection('rankings').doc(weekId);
      
      const doc = await rankingRef.get();
      let rankings = [];
      
      if (doc.exists) {
        rankings = doc.data().rankings || [];
      }
      
      // 현재 플레이어 점수가 상위 5명에 들어가는지 확인
      rankings.push(playerData);
      rankings.sort((a, b) => b.score - a.score);
      
      if (rankings.length > 5) {
        rankings = rankings.slice(0, 5); // 상위 5명만 유지
      }
      
      await rankingRef.set({ rankings: rankings });
    }

    // Firestore에서 랭킹 로드
    async function loadRankingFromFirestore() {
      const weekId = getKoreanWeekId();
      const rankingRef = db.collection('rankings').doc(weekId);
      
      const doc = await rankingRef.get();
      let rankings = [];
      
      if (doc.exists) {
        rankings = doc.data().rankings || [];
      }
      
      displayRanking(rankings);
    }

    // 로컬 스토리지에 저장
    function saveToLocalStorage(playerData) {
      const weekId = getKoreanWeekId();
      const key = `rankings_${weekId}`;
      let rankings = JSON.parse(localStorage.getItem(key) || '[]');
      
      rankings.push(playerData);
      rankings.sort((a, b) => b.score - a.score);
      
      if (rankings.length > 5) {
        rankings = rankings.slice(0, 5); // 상위 5명만 유지
      }
      
      localStorage.setItem(key, JSON.stringify(rankings));
    }

    // 로컬 스토리지에서 랭킹 로드
    function loadRankingFromLocalStorage() {
      const weekId = getKoreanWeekId();
      const key = `rankings_${weekId}`;
      const rankings = JSON.parse(localStorage.getItem(key) || '[]');
      displayRanking(rankings);
    }

    // 한국시간 기준 주차 ID 생성 (일요일 24시에 초기화)
    function getKoreanWeekId() {
      // 한국시간 (UTC+9) 계산
      const now = new Date();
      const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      // 해당 주의 일요일 찾기
      const sunday = new Date(koreanTime);
      sunday.setDate(koreanTime.getDate() - koreanTime.getDay());
      sunday.setHours(0, 0, 0, 0);
      
      const year = sunday.getFullYear();
      const month = String(sunday.getMonth() + 1).padStart(2, '0');
      const day = String(sunday.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }

    // 랭킹 표시
    function displayRanking(rankings) {
      document.getElementById('ranking-loading').style.display = 'none';
      document.getElementById('ranking-table').style.display = 'table';
      
      const tbody = document.getElementById('ranking-body');
      tbody.innerHTML = '';
      
      for (let i = 0; i < 5; i++) {
        const row = tbody.insertRow();
        const rank = i + 1;
        
        if (i < rankings.length) {
          const ranking = rankings[i];
          row.innerHTML = `
            <td>${rank}</td>
            <td>${ranking.name}</td>
            <td>${ranking.siteName}</td>
            <td>${ranking.affiliation}</td>
            <td>${ranking.score}</td>
          `;
        } else {
          row.innerHTML = `
            <td>${rank}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          `;
        }
      }
    }

    document.getElementById('saveCert').addEventListener('click', function() {
      const certificateBox = document.getElementById('certificate-box');
      html2canvas(certificateBox).then(canvas => {
        const link = document.createElement('a');
        link.download = 'certificate.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    });

    // 초기 이벤트 바인딩
    bindNextButtonEvents();
  </script>
</body>
</html>
