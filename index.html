<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‘ì—…ë³„ ë³´í˜¸êµ¬ ì°©ìš© ì˜·ì…íˆê¸° ê²Œì„</title>
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #f5f5f7;
    }
    .page { display: none; padding: 20px; }
    .active { display: block; }
    .center { text-align: center; }
    /* ì–‡ì€ ê²€ì •ìƒ‰ ë‘¥ê·¼ í…Œë‘ë¦¬ (ì• í”Œ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼) */
    .rounded-border {
      border: 1px solid black;
      border-radius: 10px;
    }
    
    /* í˜ì´ì§€1 ì• í”Œ ìŠ¤íƒ€ì¼ */
    #page1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #page1 .content-wrapper {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 60px 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      width: 90%;
    }
    #page1 h1 {
      font-size: 48px;
      font-weight: 700;
      color: #1d1d1f;
      margin-bottom: 30px;
      letter-spacing: -0.5px;
    }
    #page1 img { 
      max-width: 100%; 
      height: auto;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      margin: 30px 0;
    }
    #page1 .button {
      background: #007AFF;
      color: white;
      border: none;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
    }
    #page1 .button:hover {
      background: #0051D5;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
    }
    
    /* í˜ì´ì§€2 ì• í”Œ ìŠ¤íƒ€ì¼ */
    #page2 {
      background: #f5f5f7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #page2 .form-wrapper {
      background: white;
      border-radius: 20px;
      padding: 50px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      max-width: 500px;
      width: 90%;
    }
    #page2 h2 {
      font-size: 34px;
      font-weight: 700;
      color: #1d1d1f;
      margin-bottom: 40px;
      text-align: center;
    }
    #page2 label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #86868b;
      margin-bottom: 8px;
      margin-top: 20px;
    }
    #page2 input[type="text"] {
      width: 100%;
      padding: 16px;
      font-size: 17px;
      border: 1px solid #d2d2d7;
      border-radius: 10px;
      box-sizing: border-box;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    #page2 input[type="text"]:focus {
      outline: none;
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    #page2 .info-box {
      background: #fef2f2;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
      border: 1px solid #fca5a5;
    }
    #page2 .blink { 
      color: #dc2626;
      font-size: 16px;
      line-height: 1.6;
    }
    #page2 .button {
      background: #007AFF;
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 17px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 30px;
    }
    #page2 .button:hover {
      background: #0051D5;
    }
    
    /* í˜ì´ì§€3-7 ìŠ¤íƒ€ì¼ */
    .worker-container {
      position: relative;
      width: 100%;
      text-align: center;
    }
    /* ê·¼ë¡œì ì´ë¯¸ì§€ëŠ” ì»¨í…Œì´ë„ˆ í­ì— ë§ê²Œ 100%ë¡œ í‘œì‹œ */
    .worker-image {
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    /* ë³´í˜¸êµ¬ ê·¸ë¦¬ë“œ */
    .gear-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .gear-item {
      width: 100%;
      position: relative;
    }
    /* ë³´í˜¸êµ¬ ì¸ë„¤ì¼: 80% í¬ê¸°ë¡œ ì¶•ì†Œ, ì¤‘ì•™ ì •ë ¬, ë‘¥ê·¼ í…Œë‘ë¦¬ ì ìš© */
    .gear-item img {
      width: 80%;
      display: block;
      cursor: pointer;
      margin: 0 auto;
    }
    /* ì ìˆ˜ í‘œì‹œ - ìš°ì¸¡ í•˜ë‹¨ */
    .score-display {
      position: fixed;
      bottom: 60px;
      right: 10px;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-weight: bold;
      z-index: 1000;
      min-width: 100px;
      text-align: center;
    }
    /* ê¸°íšŒ í‘œì‹œ - ìš°ì¸¡ í•˜ë‹¨ (ì ìˆ˜ ìœ„) */
    .chances-display {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      min-width: 100px;
      text-align: center;
    }
    /* ì²« ì‚¬ì´í´: ë¬´ì œí•œ (ì´ˆë¡ìƒ‰) */
    .cycle-1 {
      background: #e8f5e8 !important;
      border: 2px solid #4caf50 !important;
      color: #2e7d32 !important;
    }
    /* ë‘ ë²ˆì§¸ ì‚¬ì´í´: 10ë²ˆ ê¸°íšŒ (ì£¼í™©ìƒ‰) */
    .cycle-2 {
      background: #fff3e0 !important;
      border: 2px solid #ff9800 !important;
      color: #e65100 !important;
    }
    /* ì„¸ ë²ˆì§¸ ì‚¬ì´í´ ì´í›„: 5ë²ˆ ê¸°íšŒ (ë¹¨ê°„ìƒ‰) */
    .cycle-3-plus {
      background: #ffebee !important;
      border: 2px solid #f44336 !important;
      color: #d32f2f !important;
    }
    
    /* í˜ì´ì§€8 ì• í”Œ ìŠ¤íƒ€ì¼ */
    #page8 {
      background: #f5f5f7;
      min-height: 100vh;
      padding: 40px 20px;
    }
    #page8 .certificate-wrapper {
      max-width: 800px;
      margin: 0 auto;
    }
    #page8 h2 {
      font-size: 48px;
      font-weight: 700;
      color: #1d1d1f;
      text-align: center;
      margin-bottom: 40px;
    }
    #certificate-box {
      background: white;
      border-radius: 20px;
      padding: 60px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    #certificate-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #007AFF, #5856D6, #AF52DE);
    }
    #certificate-box p {
      font-size: 18px;
      color: #1d1d1f;
      margin: 15px 0;
      font-weight: 500;
    }
    #certificate-box #final-score-display {
      font-size: 36px;
      font-weight: 700;
      color: #007AFF;
      margin: 30px 0;
    }
    #page8 .button-container {
      text-align: center;
      margin-top: 40px;
    }
    #page8 .button {
      background: #007AFF;
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0 10px;
    }
    #page8 .button:hover {
      background: #0051D5;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    #page8 .button.secondary {
      background: #86868b;
    }
    #page8 .button.secondary:hover {
      background: #6e6e73;
    }
    #page8 h3 {
      font-size: 28px;
      font-weight: 600;
      color: #1d1d1f;
      margin-top: 60px;
      margin-bottom: 30px;
      text-align: center;
    }
    .ranking-table {
      margin: 0 auto;
      border-collapse: collapse;
      width: 100%;
      max-width: 700px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    .ranking-table th, .ranking-table td {
      padding: 16px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
    }
    .ranking-table th {
      background-color: #007AFF;
      color: white;
      font-weight: 600;
      font-size: 16px;
    }
    .ranking-table tr:last-child td {
      border-bottom: none;
    }
    .ranking-table tr:hover {
      background-color: #f5f5f7;
    }
    .ranking-table td {
      font-size: 16px;
      color: #1d1d1f;
    }
    .loading {
      text-align: center;
      color: #86868b;
      font-style: italic;
      margin: 30px 0;
    }
    
    /* ì¼ë°˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    /* ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
    .button-group {
      margin-top: 20px;
    }
    .restart-button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }
    .restart-button:hover {
      background-color: #45a049;
    }
    
    /* ìˆ˜ë£Œì¦ ë‚´ë¶€ ì œëª© ìŠ¤íƒ€ì¼ */
    .certificate-title {
      font-size: 36px;
      font-weight: 700;
      color: #000000;
      margin-bottom: 40px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- ì ìˆ˜ í‘œì‹œ (í˜ì´ì§€ 3-7ì—ì„œë§Œ í‘œì‹œ) -->
  <div id="score-display" class="score-display" style="display: none;">
    ì ìˆ˜: <span id="current-score">0</span>
  </div>

  <!-- ê¸°íšŒ í‘œì‹œ (í˜ì´ì§€ 3-7ì—ì„œë§Œ í‘œì‹œ) -->
  <div id="chances-display" class="chances-display" style="display: none;">
    í´ë¦­ ê¸°íšŒ: <span id="remaining-chances">âˆ</span>
  </div>

  <!-- í˜ì´ì§€1: ì‹œì‘ í™”ë©´ -->
  <div id="page1" class="page active">
    <div class="content-wrapper">
      <div class="center">
        <h1>ì‘ì—…ë³„ ë³´í˜¸êµ¬ ì°©ìš© êµìœ¡</h1>
        <img src="https://i.imgur.com/Tu6mJ5J.png" alt="ë©”ì¸ ì´ë¯¸ì§€">
        <br>
        <button class="button" id="startButton">êµìœ¡ ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- í˜ì´ì§€2: êµìœ¡ ì •ë³´ ì…ë ¥ -->
  <div id="page2" class="page">
    <div class="form-wrapper">
      <h2>êµìœ¡ ì •ë³´ ì…ë ¥</h2>
      <label>í˜„ì¥ëª…:</label>
      <input type="text" id="siteName" placeholder="í˜„ì¥ëª… ì…ë ¥">
      
      <label>ê·¼ë¡œì ì´ë¦„:</label>
      <input type="text" id="workerName" placeholder="ì´ë¦„ ì…ë ¥">
      
      <label>ì†Œì†:</label>
      <input type="text" id="workerAffiliation" placeholder="ì†Œì† ì…ë ¥">
      
      <div class="info-box">
        <div class="blink">ì‘ì—… ìƒí™©ì— ë”°ë¥¸ ë³´í˜¸êµ¬ ì°©ìš© ê¸°ì¤€ì„ ì˜·ì…íˆê¸° ê²Œì„ ë°©ì‹ìœ¼ë¡œ í•™ìŠµí•©ë‹ˆë‹¤. ê·¼ë¡œì ìºë¦­í„° í•˜ë‹¨ì˜ ë³´í˜¸êµ¬ë¥¼ í´ë¦­í•˜ì—¬ ì˜¬ë°”ë¥¸ ë³´í˜¸êµ¬ë¥¼ ì°©ìš©ì‹œì¼œì£¼ì„¸ìš”.</div>
      </div>
      
      <button class="button" id="toPage3">ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€3: ê³ ì†Œì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬ -->
  <div id="page3" class="page">
    <h2>ê³ ì†Œì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-3"></div>
    <div id="error-message-3" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-3">
      <button class="button" id="next-button-3" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€4: ìš©ì ‘ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬ -->
  <div id="page4" class="page">
    <h2>ìš©ì ‘ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-4"></div>
    <div id="error-message-4" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-4">
      <button class="button" id="next-button-4" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€5: ì •ì „ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬ -->
  <div id="page5" class="page">
    <h2>ì •ì „ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-5"></div>
    <div id="error-message-5" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-5">
      <button class="button" id="next-button-5" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€6: ë„ì¥ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬ -->
  <div id="page6" class="page">
    <h2>ë„ì¥ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-6"></div>
    <div id="error-message-6" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-6">
      <button class="button" id="next-button-6" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€7: ì¼ë°˜ì‘ì—… ê³µí†µì°©ìš© ê°œì¸ë³´í˜¸êµ¬ -->
  <div id="page7" class="page">
    <h2>ì¼ë°˜ì‘ì—… ê³µí†µì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-7"></div>
    <div id="error-message-7" style="color: red; text-align: center; margin-top: 10px;"></div>
    <div class="center button-group" id="button-container-7">
      <button class="button" id="next-button-7" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€8: ìˆ˜ë£Œì¦ í™”ë©´ -->
  <div id="page8" class="page">
    <div class="certificate-wrapper">
      <h2>êµìœ¡ ì™„ë£Œ</h2>
      <div id="certificate-box">
        <div class="certificate-title">ìˆ˜ë£Œì¦</div>
        <p id="cert-siteName"></p>
        <p id="cert-workerName"></p>
        <p id="cert-workerAffiliation"></p>
        <p id="final-score-display">ìµœì¢… ì ìˆ˜: <span id="final-score">0</span>ì </p>
        <p>ë³´í˜¸êµ¬ êµìœ¡ì„ ëª¨ë‘ ìˆ˜ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="button-container">
        <p style="color: #86868b; margin-bottom: 20px;">ê´€ë¦¬ìì—ê²Œ ìˆ˜ë£Œì¦ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”</p>
        <button class="button" id="saveCert">ì €ì¥í•˜ê¸°</button>
        <button class="button secondary" id="homeButton">í™ˆìœ¼ë¡œ</button>
      </div>
      
      <h3>ğŸ† ì´ë²ˆ ì£¼ ë­í‚¹</h3>
      <div id="ranking-loading" class="loading">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <table id="ranking-table" class="ranking-table" style="display: none;">
        <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>ê·¼ë¡œì ì´ë¦„</th>
            <th>í˜„ì¥ëª…</th>
            <th>ì†Œì†</th>
            <th>ì ìˆ˜</th>
          </tr>
        </thead>
        <tbody id="ranking-body">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- html2canvas (ìˆ˜ë£Œì¦ ìº¡ì³ìš©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Firebase ì„¤ì • - ì‹¤ì œ í”„ë¡œì íŠ¸ ì„¤ì • ì ìš©ë¨
    const firebaseConfig = {
      apiKey: "AIzaSyDqZFIp_jzaUFiNlZxO3AYI3b8H9zDgyW4",
      authDomain: "training-private-equipment.firebaseapp.com",
      projectId: "training-private-equipment",
      storageBucket: "training-private-equipment.firebasestorage.app",
      messagingSenderId: "428074253490",
      appId: "1:428074253490:web:77d4040f8af17338795dab"
    };

    // Firebase ì´ˆê¸°í™” (ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©)
    let db = null;
    try {
      if (firebaseConfig.apiKey !== "your-api-key") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
      }
    } catch (error) {
      console.log("Firebase ì„¤ì •ì´ ì—†ì–´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
    }

    // ê° í˜ì´ì§€ë³„ ë³´í˜¸êµ¬ ë°ì´í„°
    const pageGearData = {
      3: [
        { id: 1, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/8gsL65v.png', overlay: 'https://i.imgur.com/zBCjthf.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: 'https://i.imgur.com/VfJMtc3.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/m1GZRHc.png', overlay: 'https://i.imgur.com/Cphm4b5.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      4: [
        { id: 1, thumbnail: 'https://imgur.com/n6iJRus.png', overlay: '', correct: false, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/oU1hjTk.png', overlay: 'https://i.imgur.com/cPHvWTb.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: 'https://i.imgur.com/S77YoN3.png', correct: true, applied: false, zIndex: 4 },
        { id: 4, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: 'https://i.imgur.com/v5kUQPg.png', correct: true, applied: false, zIndex: 3 },
        { id: 5, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      5: [
        { id: 1, thumbnail: 'https://i.imgur.com/NnWSEdz.png', overlay: 'https://i.imgur.com/ImnVVaf.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/NdbXUPl.png', overlay: 'https://i.imgur.com/IMelM9Q.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/Z5ojhhi.png', overlay: 'https://i.imgur.com/3KX2VD4.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      6: [
        { id: 1, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: 'https://i.imgur.com/fdH4wzC.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/F1PF0tE.png', overlay: 'https://i.imgur.com/Gctejg5.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/n6iJRus.png', overlay: 'https://i.imgur.com/oAQe9gI.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/NdbXUPl.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      7: [
        { id: 1, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: 'https://i.imgur.com/VfJMtc3.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/m1GZRHc.png', overlay: 'https://i.imgur.com/Cphm4b5.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ]
    };

    // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
    let currentScore = 0;
    let gameSequence = [3, 4, 5, 6, 7]; // ê¸°ë³¸ í˜ì´ì§€ ìˆœì„œ
    let currentSequenceIndex = 0;
    let hasCompletedFirstCycle = false;
    let isInRandomCycle = false;
    let cycleCount = 1; // í˜„ì¬ ì‚¬ì´í´ íšŸìˆ˜
    let remainingChances = Infinity; // ë‚¨ì€ ê¸°íšŒ
    let maxChancesPerCycle = {
      1: Infinity, // ì²« ë²ˆì§¸ ì‚¬ì´í´: ë¬´ì œí•œ
      2: 10,       // ë‘ ë²ˆì§¸ ì‚¬ì´í´: 10ë²ˆ
      default: 5   // ì„¸ ë²ˆì§¸ ì‚¬ì´í´ ì´í›„: 5ë²ˆ
    };

    // ì ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateScore() {
      currentScore += 1;
      document.getElementById('current-score').textContent = currentScore;
    }

    // ì ìˆ˜ í‘œì‹œ/ìˆ¨ê¹€
    function showScore() {
      document.getElementById('score-display').style.display = 'block';
    }

    function hideScore() {
      document.getElementById('score-display').style.display = 'none';
    }

    // ê¸°íšŒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateChances() {
      const chancesElement = document.getElementById('remaining-chances');
      const chancesDisplay = document.getElementById('chances-display');
      
      // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
      chancesDisplay.classList.remove('cycle-1', 'cycle-2', 'cycle-3-plus');
      
      if (remainingChances === Infinity) {
        chancesElement.textContent = 'âˆ';
        chancesDisplay.classList.add('cycle-1'); // ì´ˆë¡ìƒ‰
      } else if (cycleCount === 2) {
        chancesElement.textContent = Math.max(0, remainingChances); // 0 ì´í•˜ì¼ ë•ŒëŠ” 0ìœ¼ë¡œ í‘œì‹œ
        chancesDisplay.classList.add('cycle-2'); // ì£¼í™©ìƒ‰
      } else {
        chancesElement.textContent = Math.max(0, remainingChances); // 0 ì´í•˜ì¼ ë•ŒëŠ” 0ìœ¼ë¡œ í‘œì‹œ
        chancesDisplay.classList.add('cycle-3-plus'); // ë¹¨ê°„ìƒ‰
      }
    }

    // ê¸°íšŒ í‘œì‹œ/ìˆ¨ê¹€
    function showChances() {
      document.getElementById('chances-display').style.display = 'block';
      updateChances();
    }

    function hideChances() {
      document.getElementById('chances-display').style.display = 'none';
    }

    // ê¸°íšŒ ì°¨ê°
    function decreaseChances() {
      if (remainingChances !== Infinity) {
        remainingChances--;
        updateChances();
        
        console.log(`ğŸ¯ ê¸°íšŒ ì°¨ê°: ${remainingChances} ë‚¨ìŒ (ì‚¬ì´í´ ${cycleCount})`);
        
        if (remainingChances < 0) {
          // í—ˆìš©ëœ í´ë¦­ ìˆ˜ë¥¼ ì´ˆê³¼í•œ ê²½ìš° ê²Œì„ ì¢…ë£Œ
          console.log('ğŸ’€ í—ˆìš©ëœ í´ë¦­ ìˆ˜ ì´ˆê³¼ë¡œ ê²Œì„ ì¢…ë£Œ');
          setTimeout(() => {
            if (cycleCount === 2) {
              alert(`í˜ì´ì§€ì—ì„œ í—ˆìš©ëœ 10ë²ˆì˜ ê¸°íšŒë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!\ní˜„ì¬ ì ìˆ˜: ${currentScore}ì \nê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.`);
            } else {
              alert(`í˜ì´ì§€ì—ì„œ í—ˆìš©ëœ 5ë²ˆì˜ ê¸°íšŒë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!\ní˜„ì¬ ì ìˆ˜: ${currentScore}ì \nê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.`);
            }
            goToPage8();
          }, 500);
          return true; // ê²Œì„ ì¢…ë£Œë¨
        }
      }
      return false; // ê²Œì„ ê³„ì†
    }

    // ì‚¬ì´í´ë³„ ê¸°íšŒ ì„¤ì •
    function setChancesForCycle() {
      if (cycleCount === 1) {
        remainingChances = Infinity;
        console.log(`ğŸŸ¢ ì‚¬ì´í´ ${cycleCount}: ë¬´ì œí•œ ê¸°íšŒ ì„¤ì •`);
      } else if (cycleCount === 2) {
        remainingChances = maxChancesPerCycle[2];
        console.log(`ğŸŸ¡ ì‚¬ì´í´ ${cycleCount}: ${remainingChances}ë²ˆ ê¸°íšŒ ì„¤ì •`);
      } else {
        remainingChances = maxChancesPerCycle.default;
        console.log(`ğŸ”´ ì‚¬ì´í´ ${cycleCount}: ${remainingChances}ë²ˆ ê¸°íšŒ ì„¤ì •`);
      }
      updateChances();
    }

    // í˜ì´ì§€ ì „í™˜ ì´ë²¤íŠ¸
    document.getElementById('startButton').addEventListener('click', function() {
      showPage('page2');
    });

    document.getElementById('toPage3').addEventListener('click', function() {
      if(document.getElementById('siteName').value.trim() === '' || 
         document.getElementById('workerName').value.trim() === '' || 
         document.getElementById('workerAffiliation').value.trim() === '') {
        alert('í˜„ì¥ëª…, ê·¼ë¡œì ì´ë¦„, ì†Œì†ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ê²Œì„ ì™„ì „ ì´ˆê¸°í™”
      currentScore = 0;
      currentSequenceIndex = 0;
      hasCompletedFirstCycle = false;
      isInRandomCycle = false;
      gameSequence = [3, 4, 5, 6, 7];
      cycleCount = 1; // ì²« ë²ˆì§¸ ì‚¬ì´í´ë¡œ ëª…ì‹œì  ì´ˆê¸°í™”
      
      console.log('ğŸ® ê²Œì„ ì‹œì‘ - ì²« ë²ˆì§¸ ì‚¬ì´í´ (ë¬´ì œí•œ ê¸°íšŒ)');
      
      // ëª¨ë“  í˜ì´ì§€ì˜ ë²„íŠ¼ì„ ê¸°ë³¸ ìƒíƒœë¡œ ì´ˆê¸°í™”
      for (let i = 3; i <= 7; i++) {
        const buttonContainer = document.getElementById(`button-container-${i}`);
        if (buttonContainer) {
          buttonContainer.innerHTML = `<button class="button" id="next-button-${i}" disabled>ë‹¤ìŒ</button>`;
        }
      }
      
      document.getElementById('current-score').textContent = currentScore;
      setChancesForCycle(); // ì²« ì‚¬ì´í´ ê¸°íšŒ ì„¤ì • (ë¬´ì œí•œ)
      showScore();
      showChances();
      showPage('page3');
      initializeGame(3);
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ë°”ì¸ë”©
      bindNextButtonEvents();
    });

    // ë‹¤ìŒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜
    function bindNextButtonEvents() {
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
      document.querySelectorAll('[id^="next-button-"]').forEach(button => {
        button.replaceWith(button.cloneNode(true));
      });

      // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.getElementById('next-button-3').addEventListener('click', () => goToNextPage());
      document.getElementById('next-button-4').addEventListener('click', () => goToNextPage());
      document.getElementById('next-button-5').addEventListener('click', () => goToNextPage());
      document.getElementById('next-button-6').addEventListener('click', () => goToNextPage());
      document.getElementById('next-button-7').addEventListener('click', () => goToNextPage());
    }

    // ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
    function goToNextPage() {
      updateScore();
      currentSequenceIndex++;

      if (currentSequenceIndex >= gameSequence.length) {
        // ì‚¬ì´í´ ì™„ë£Œ
        if (cycleCount === 1) {
          // ì²« ë²ˆì§¸ ì‚¬ì´í´ ì™„ë£Œ
          hasCompletedFirstCycle = true;
          // ì‚¬ì´í´ ì™„ë£Œ ë²„íŠ¼ í‘œì‹œ (ì•„ì§ cycleCountëŠ” ì¦ê°€ì‹œí‚¤ì§€ ì•ŠìŒ)
          showCycleCompleteButtons(gameSequence[gameSequence.length - 1]);
        } else {
          // ë‘ ë²ˆì§¸ ì‚¬ì´í´ ì´í›„ ì™„ë£Œ
          showCycleCompleteButtons(gameSequence[gameSequence.length - 1]);
        }
        return;
      }

      const nextPageNum = gameSequence[currentSequenceIndex];
      
      // ğŸ”„ í˜ì´ì§€ ì´ë™ ì‹œ ê¸°íšŒ ì´ˆê¸°í™”
      setChancesForCycle();
      console.log(`ğŸ“„ í˜ì´ì§€ ${nextPageNum}ë¡œ ì´ë™ - ê¸°íšŒ ì´ˆê¸°í™”: ${remainingChances}`);
      
      showPage(`page${nextPageNum}`);
      initializeGame(nextPageNum);
    }

    // ê²Œì„ ì™„ë£Œ ì²´í¬ (ë³´í˜¸êµ¬ë¥¼ ëª¨ë‘ ì°©ìš©í–ˆì„ ë•Œ í˜¸ì¶œ)
    function checkGameComplete(pageNum) {
      const gearItems = pageGearData[pageNum];
      const allApplied = gearItems.filter(item => item.correct).every(item => item.applied);
      
      const nextButton = document.getElementById(`next-button-${pageNum}`);
      if (nextButton) nextButton.disabled = !allApplied;
      
      // ëª¨ë“  ë³´í˜¸êµ¬ë¥¼ ì°©ìš©í–ˆê³ , ì´ê²ƒì´ ì‚¬ì´í´ì˜ ë§ˆì§€ë§‰ í˜ì´ì§€ì¸ ê²½ìš°
      if (allApplied && currentSequenceIndex === gameSequence.length - 1) {
        // ì²« ë²ˆì§¸ ì‚¬ì´í´ì´ê±°ë‚˜ ì´ë¯¸ ì²« ì‚¬ì´í´ì„ ì™„ë£Œí•œ ê²½ìš°
        if (cycleCount === 1 || hasCompletedFirstCycle) {
          showCycleCompleteButtons(pageNum);
        }
      }
    }

    // ì‚¬ì´í´ ì™„ë£Œ ì‹œ ë²„íŠ¼ í‘œì‹œ
    function showCycleCompleteButtons(pageNum) {
      const buttonContainer = document.getElementById(`button-container-${pageNum}`);
      
      if (buttonContainer) {
        buttonContainer.innerHTML = `
          <button class="button" onclick="goToPage8()">ë‹¤ìŒ</button>
          <button class="restart-button" onclick="startNewRandomCycle()">ë‹¤ì‹œ í•™ìŠµí•˜ê¸°</button>
        `;
      }
    }

    // í˜ì´ì§€8ë¡œ ì´ë™
    function goToPage8() {
      hideScore();
      hideChances();
      document.getElementById('final-score').textContent = currentScore;
      document.getElementById('cert-siteName').innerText = "í˜„ì¥ëª…: " + document.getElementById('siteName').value;
      document.getElementById('cert-workerName').innerText = "ê·¼ë¡œì ì´ë¦„: " + document.getElementById('workerName').value;
      document.getElementById('cert-workerAffiliation').innerText = "ì†Œì†: " + document.getElementById('workerAffiliation').value;
      showPage('page8');
      saveScoreAndLoadRanking();
    }

    // ìƒˆë¡œìš´ ëœë¤ ì‚¬ì´í´ ì‹œì‘
    function startNewRandomCycle() {
      // ì‚¬ì´í´ ì¹´ìš´íŠ¸ ì¦ê°€
      cycleCount++;
      console.log(`ğŸ”„ ìƒˆë¡œìš´ ì‚¬ì´í´ ì‹œì‘: ${cycleCount}`);
      
      isInRandomCycle = true;
      gameSequence = shuffle([3, 4, 5, 6, 7]);
      currentSequenceIndex = 0;
      
      console.log(`ğŸ“Š ì‚¬ì´í´ ${cycleCount} ì‹œì‘ - ìˆœì„œ: [${gameSequence.join(',')}]`);
      
      // ëª¨ë“  í˜ì´ì§€ì˜ ë²„íŠ¼ì„ ê¸°ë³¸ ìƒíƒœë¡œ ì´ˆê¸°í™”
      for (let i = 3; i <= 7; i++) {
        const buttonContainer = document.getElementById(`button-container-${i}`);
        if (buttonContainer) {
          buttonContainer.innerHTML = `<button class="button" id="next-button-${i}" disabled>ë‹¤ìŒ</button>`;
        }
      }
      
      const firstPageNum = gameSequence[0];
      showPage(`page${firstPageNum}`);
      initializeGame(firstPageNum); // ì—¬ê¸°ì„œ ê¸°íšŒ ì„¤ì •ë¨
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ë°”ì¸ë”©
      bindNextButtonEvents();
    }

    document.getElementById('homeButton').addEventListener('click', function() {
      location.reload();
    });

    // ì§€ì •í•œ í˜ì´ì§€ í‘œì‹œ
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(function(page) {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function initializeGame(pageNum) {
      const gearItems = pageGearData[pageNum];
      gearItems.forEach(item => item.applied = false);
      const shuffledItems = shuffle([...gearItems]);
      const gearGrid = document.getElementById(`gear-grid-${pageNum}`);
      gearGrid.innerHTML = '';
      
      // ğŸ”„ ì²« í˜ì´ì§€ì¸ ê²½ìš°ì—ë§Œ ê¸°íšŒ ì„¤ì • (ë‹¤ë¥¸ í˜ì´ì§€ëŠ” goToNextPageì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
      if (currentSequenceIndex === 0) {
        setChancesForCycle();
        console.log(`ğŸ® ì²« í˜ì´ì§€ ${pageNum} ì‹œì‘ - ê¸°íšŒ: ${remainingChances}`);
      }
      
      shuffledItems.forEach(item => {
        const gearDiv = document.createElement('div');
        gearDiv.className = 'gear-item';
        const img = document.createElement('img');
        img.src = item.thumbnail;
        img.classList.add('rounded-border');
        img.dataset.id = item.id;
        
        // í´ë¦­ í•­ìƒ í™œì„±í™” (ê¸°íšŒê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ)
        img.style.pointerEvents = 'auto';
        img.style.opacity = '1';
        img.style.cursor = 'pointer';
        
        img.addEventListener('click', function() {
          handleGearClick(item, img, pageNum);
        });
        
        gearDiv.appendChild(img);
        gearGrid.appendChild(gearDiv);
      });
      
      // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      workerContainer.querySelectorAll('.overlay').forEach(overlay => overlay.remove());
      
      // ë‹¤ìŒ ë²„íŠ¼ ë¹„í™œì„±í™”
      const nextButton = document.getElementById(`next-button-${pageNum}`);
      if (nextButton) nextButton.disabled = true;
      
      document.getElementById(`error-message-${pageNum}`).innerText = '';
      
      console.log(`ğŸ¯ í˜ì´ì§€ ${pageNum} ì´ˆê¸°í™” ì™„ë£Œ (ì‚¬ì´í´ ${cycleCount}, ê¸°íšŒ: ${remainingChances})`);
    }

    function handleGearClick(item, imgElement, pageNum) {
      console.log(`ğŸ‘† ë³´í˜¸êµ¬ í´ë¦­: ${item.correct ? 'ì˜¬ë°”ë¦„' : 'í‹€ë¦¼'} (ì‚¬ì´í´ ${cycleCount})`);
      
      // ì²« ë²ˆì§¸ ì‚¬ì´í´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê¸°íšŒ ì°¨ê°
      if (cycleCount > 1) {
        const gameEnded = decreaseChances();
        if (gameEnded) {
          return; // ê²Œì„ì´ ì¢…ë£Œëœ ê²½ìš° ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
        }
      }

      if(item.correct) {
        if(!item.applied) {
          imgElement.style.opacity = 0.5;
          item.applied = true;
          addOverlayImage(item, pageNum);
        } else {
          imgElement.style.opacity = 1;
          item.applied = false;
          removeOverlayImage(item, pageNum);
        }
      } else {
        document.getElementById(`error-message-${pageNum}`).innerText = 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë³´í˜¸êµ¬ì…ë‹ˆë‹¤.';
        setTimeout(() => {
          document.getElementById(`error-message-${pageNum}`).innerText = '';
        }, 2000);
      }
      checkAllCorrectApplied(pageNum);
    }

    function addOverlayImage(item, pageNum) {
      if(!item.overlay) return;
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      const overlayImg = document.createElement('img');
      overlayImg.src = item.overlay;
      overlayImg.className = 'overlay';
      overlayImg.dataset.id = item.id;
      overlayImg.style.position = 'absolute';
      overlayImg.style.top = '0';
      overlayImg.style.left = '0';
      overlayImg.style.width = '100%';
      overlayImg.style.height = '100%';
      overlayImg.style.zIndex = item.zIndex;
      workerContainer.appendChild(overlayImg);
    }

    function removeOverlayImage(item, pageNum) {
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      const overlay = workerContainer.querySelector(`img.overlay[data-id="${item.id}"]`);
      if(overlay) overlay.remove();
    }

    function checkAllCorrectApplied(pageNum) {
      checkGameComplete(pageNum);
    }

    // ì ìˆ˜ ì €ì¥ ë° ë­í‚¹ ë¡œë“œ
    async function saveScoreAndLoadRanking() {
      const playerData = {
        name: document.getElementById('workerName').value,
        siteName: document.getElementById('siteName').value,
        affiliation: document.getElementById('workerAffiliation').value,
        score: currentScore,
        timestamp: new Date()
      };

      try {
        if (db) {
          // Firestore ì‚¬ìš©
          await saveToFirestore(playerData);
          await loadRankingFromFirestore();
        } else {
          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
          saveToLocalStorage(playerData);
          loadRankingFromLocalStorage();
        }
      } catch (error) {
        console.error('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', error);
        // Firestore ì‹¤íŒ¨ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¡œ fallback
        saveToLocalStorage(playerData);
        loadRankingFromLocalStorage();
      }
    }

    // Firestoreì— ì €ì¥
    async function saveToFirestore(playerData) {
      const weekId = getKoreanWeekId();
      const rankingRef = db.collection('rankings').doc(weekId);
      
      const doc = await rankingRef.get();
      let rankings = [];
      
      if (doc.exists) {
        rankings = doc.data().rankings || [];
      }
      
      // í˜„ì¬ í”Œë ˆì´ì–´ ì ìˆ˜ê°€ ìƒìœ„ 5ëª…ì— ë“¤ì–´ê°€ëŠ”ì§€ í™•ì¸
      rankings.push(playerData);
      rankings.sort((a, b) => b.score - a.score);
      
      if (rankings.length > 5) {
        rankings = rankings.slice(0, 5); // ìƒìœ„ 5ëª…ë§Œ ìœ ì§€
      }
      
      await rankingRef.set({ rankings: rankings });
    }

    // Firestoreì—ì„œ ë­í‚¹ ë¡œë“œ
    async function loadRankingFromFirestore() {
      const weekId = getKoreanWeekId();
      const rankingRef = db.collection('rankings').doc(weekId);
      
      const doc = await rankingRef.get();
      let rankings = [];
      
      if (doc.exists) {
        rankings = doc.data().rankings || [];
      }
      
      displayRanking(rankings);
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    function saveToLocalStorage(playerData) {
      const weekId = getKoreanWeekId();
      const key = `rankings_${weekId}`;
      let rankings = JSON.parse(localStorage.getItem(key) || '[]');
      
      rankings.push(playerData);
      rankings.sort((a, b) => b.score - a.score);
      
      if (rankings.length > 5) {
        rankings = rankings.slice(0, 5); // ìƒìœ„ 5ëª…ë§Œ ìœ ì§€
      }
      
      localStorage.setItem(key, JSON.stringify(rankings));
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë­í‚¹ ë¡œë“œ
    function loadRankingFromLocalStorage() {
      const weekId = getKoreanWeekId();
      const key = `rankings_${weekId}`;
      const rankings = JSON.parse(localStorage.getItem(key) || '[]');
      displayRanking(rankings);
    }

    // í•œêµ­ì‹œê°„ ê¸°ì¤€ ì£¼ì°¨ ID ìƒì„± (ì¼ìš”ì¼ 24ì‹œì— ì´ˆê¸°í™”)
    function getKoreanWeekId() {
      // í•œêµ­ì‹œê°„ (UTC+9) ê³„ì‚°
      const now = new Date();
      const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      // í•´ë‹¹ ì£¼ì˜ ì¼ìš”ì¼ ì°¾ê¸°
      const sunday = new Date(koreanTime);
      sunday.setDate(koreanTime.getDate() - koreanTime.getDay());
      sunday.setHours(0, 0, 0, 0);
      
      const year = sunday.getFullYear();
      const month = String(sunday.getMonth() + 1).padStart(2, '0');
      const day = String(sunday.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }

    // ë­í‚¹ í‘œì‹œ
    function displayRanking(rankings) {
      document.getElementById('ranking-loading').style.display = 'none';
      document.getElementById('ranking-table').style.display = 'table';
      
      const tbody = document.getElementById('ranking-body');
      tbody.innerHTML = '';
      
      for (let i = 0; i < 5; i++) {
        const row = tbody.insertRow();
        const rank = i + 1;
        
        if (i < rankings.length) {
          const ranking = rankings[i];
          row.innerHTML = `
            <td>${rank}</td>
            <td>${ranking.name}</td>
            <td>${ranking.siteName}</td>
            <td>${ranking.affiliation}</td>
            <td>${ranking.score}</td>
          `;
        } else {
          row.innerHTML = `
            <td>${rank}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          `;
        }
      }
    }

    document.getElementById('saveCert').addEventListener('click', function() {
      const certificateBox = document.getElementById('certificate-box');
      html2canvas(certificateBox).then(canvas => {
        const link = document.createElement('a');
        link.download = 'certificate.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    });

    // ì´ˆê¸° ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindNextButtonEvents();
  </script>
</body>
</html>if (currentSequenceIndex >= gameSequence.length) {
        // ì‚¬ì´í´ ì™„ë£Œ
        if (cycleCount === 1) {
          // ì²« ë²ˆì§¸ ì‚¬ì´í´ ì™„ë£Œ
          hasCompletedFirstCycle = true;
          // ì‚¬ì´í´ ì™„ë£Œ ë²„íŠ¼ í‘œì‹œ (ì•„ì§ cycleCountëŠ” ì¦ê°€ì‹œí‚¤ì§€ ì•ŠìŒ)
          showCycleCompleteButtons(gameSequence[gameSequence.length - 1]);
        } else {
          // ë‘ ë²ˆì§¸ ì‚¬ì´í´ ì´í›„ ì™„ë£Œ
          showCycleCompleteButtons(gameSequence[gameSequence.length - 1]);
        }
        return;
      }

      const nextPageNum = gameSequence[currentSequenceIndex];
      
      // ğŸ”„ í˜ì´ì§€ ì´ë™ ì‹œ ê¸°íšŒ ì´ˆê¸°í™”
      setChancesForCycle();
      console.log(`ğŸ“„ í˜ì´ì§€ ${nextPageNum}ë¡œ ì´ë™ - ê¸°íšŒ ì´ˆê¸°í™”: ${remainingChances}`);
      
      showPage(`page${nextPageNum}`);
      initializeGame(nextPageNum);
    }

    // ê²Œì„ ì™„ë£Œ ì²´í¬ (ë³´í˜¸êµ¬ë¥¼ ëª¨ë‘ ì°©ìš©í–ˆì„ ë•Œ í˜¸ì¶œ)
    function checkGameComplete(pageNum) {
      const gearItems = pageGearData[pageNum];
      const allApplied = gearItems.filter(item => item.correct).every(item => item.applied);
      
      const nextButton = document.getElementById(`next-button-${pageNum}`);
      if (nextButton) nextButton.disabled = !allApplied;
      
      // ëª¨ë“  ë³´í˜¸êµ¬ë¥¼ ì°©ìš©í–ˆê³ , ì´ê²ƒì´ ì‚¬ì´í´ì˜ ë§ˆì§€ë§‰ í˜ì´ì§€ì¸ ê²½ìš°
      if (allApplied && currentSequenceIndex === gameSequence.length - 1) {
        // ì²« ë²ˆì§¸ ì‚¬ì´í´ì´ê±°ë‚˜ ì´ë¯¸ ì²« ì‚¬ì´í´ì„ ì™„ë£Œí•œ ê²½ìš°
        if (cycleCount === 1 || hasCompletedFirstCycle) {
          showCycleCompleteButtons(pageNum);
        }
      }
    }

    // ì‚¬ì´í´ ì™„ë£Œ ì‹œ ë²„íŠ¼ í‘œì‹œ
    function showCycleCompleteButtons(pageNum) {
      const buttonContainer = document.getElementById(`button-container-${pageNum}`);
      
      if (buttonContainer) {
        buttonContainer.innerHTML = `
          <button class="button" onclick="goToPage8()">ë‹¤ìŒ</button>
          <button class="restart-button" onclick="startNewRandomCycle()">ë‹¤ì‹œ í•™ìŠµí•˜ê¸°</button>
        `;
      }
    }

    // í˜ì´ì§€8ë¡œ ì´ë™
    function goToPage8() {
      hideScore();
      hideChances();
      document.getElementById('final-score').textContent = currentScore;
      document.getElementById('cert-siteName').innerText = "í˜„ì¥ëª…: " + document.getElementById('siteName').value;
      document.getElementById('cert-workerName').innerText = "ê·¼ë¡œì ì´ë¦„: " + document.getElementById('workerName').value;
      document.getElementById('cert-workerAffiliation').innerText = "ì†Œì†: " + document.getElementById('workerAffiliation').value;
      showPage('page8');
      saveScoreAndLoadRanking();
    }

    // ìƒˆë¡œìš´ ëœë¤ ì‚¬ì´í´ ì‹œì‘
    function startNewRandomCycle() {
      // ì‚¬ì´í´ ì¹´ìš´íŠ¸ ì¦ê°€
      cycleCount++;
      console.log(`ğŸ”„ ìƒˆë¡œìš´ ì‚¬ì´í´ ì‹œì‘: ${cycleCount}`);
      
      isInRandomCycle = true;
      gameSequence = shuffle([3, 4, 5, 6, 7]);
      currentSequenceIndex = 0;
      
      console.log(`ğŸ“Š ì‚¬ì´í´ ${cycleCount} ì‹œì‘ - ìˆœì„œ: [${gameSequence.join(',')}]`);
      
      // ëª¨ë“  í˜ì´ì§€ì˜ ë²„íŠ¼ì„ ê¸°ë³¸ ìƒíƒœë¡œ ì´ˆê¸°í™”
      for (let i = 3; i <= 7; i++) {
        const buttonContainer = document.getElementById(`button-container-${i}`);
        if (buttonContainer) {
          buttonContainer.innerHTML = `<button class="button" id="next-button-${i}" disabled>ë‹¤ìŒ</button>`;
        }
      }
      
      const firstPageNum = gameSequence[0];
      showPage(`page${firstPageNum}`);
      initializeGame(firstPageNum); // ì—¬ê¸°ì„œ ê¸°íšŒ ì„¤ì •ë¨
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ë°”ì¸ë”©
      bindNextButtonEvents();
    }

    document.getElementById('homeButton').addEventListener('click', function() {
      location.reload();
    });

    // ì§€ì •í•œ í˜ì´ì§€ í‘œì‹œ
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(function(page) {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function initializeGame(pageNum) {
      const gearItems = pageGearData[pageNum];
      gearItems.forEach(item => item.applied = false);
      const shuffledItems = shuffle([...gearItems]);
      const gearGrid = document.getElementById(`gear-grid-${pageNum}`);
      gearGrid.innerHTML = '';
      
      // ğŸ”„ ì²« í˜ì´ì§€ì¸ ê²½ìš°ì—ë§Œ ê¸°íšŒ ì„¤ì • (ë‹¤ë¥¸ í˜ì´ì§€ëŠ” goToNextPageì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
      if (currentSequenceIndex === 0) {
        setChancesForCycle();
        console.log(`ğŸ® ì²« í˜ì´ì§€ ${pageNum} ì‹œì‘ - ê¸°íšŒ: ${remainingChances}`);
      }
      
      shuffledItems.forEach(item => {
        const gearDiv = document.createElement('div');
        gearDiv.className = 'gear-item';
        const img = document.createElement('img');
        img.src = item.thumbnail;
        img.classList.add('rounded-border');
        img.dataset.id = item.id;
        
        // í´ë¦­ í•­ìƒ í™œì„±í™” (ê¸°íšŒê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ)
        img.style.pointerEvents = 'auto';
        img.style.opacity = '1';
        img.style.cursor = 'pointer';
        
        img.addEventListener('click', function() {
          handleGearClick(item, img, pageNum);
        });
        
        gearDiv.appendChild(img);
        gearGrid.appendChild(gearDiv);
      });
      
      // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      workerContainer.querySelectorAll('.overlay').forEach(overlay => overlay.remove());
      
      // ë‹¤ìŒ ë²„íŠ¼ ë¹„í™œì„±í™”
      const nextButton = document.getElementById(`next-button-${pageNum}`);
      if (nextButton) nextButton.disabled = true;
      
      document.getElementById(`error-message-${pageNum}`).innerText = '';
      
      console.log(`ğŸ¯ í˜ì´ì§€ ${pageNum} ì´ˆê¸°í™” ì™„ë£Œ (ì‚¬ì´í´ ${cycleCount}, ê¸°íšŒ: ${remainingChances})`);
    }

    function handleGearClick(item, imgElement, pageNum) {
      console.log(`ğŸ‘† ë³´í˜¸êµ¬ í´ë¦­: ${item.correct ? 'ì˜¬ë°”ë¦„' : 'í‹€ë¦¼'} (ì‚¬ì´í´ ${cycleCount})`);
      
      // ì²« ë²ˆì§¸ ì‚¬ì´í´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê¸°íšŒ ì°¨ê°
      if (cycleCount > 1) {
        const gameEnded = decreaseChances();
        if (gameEnded) {
          return; // ê²Œì„ì´ ì¢…ë£Œëœ ê²½ìš° ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
        }
      }

      if(item.correct) {
        if(!item.applied) {
          imgElement.style.opacity = 0.5;
          item.applied = true;
          addOverlayImage(item, pageNum);
        } else {
          imgElement.style.opacity = 1;
          item.applied = false;
          removeOverlayImage(item, pageNum);
        }
      } else {
        document.getElementById(`error-message-${pageNum}`).innerText = 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë³´í˜¸êµ¬ì…ë‹ˆë‹¤.';
        setTimeout(() => {
          document.getElementById(`error-message-${pageNum}`).innerText = '';
        }, 2000);
      }
      checkAllCorrectApplied(pageNum);
    }

    function addOverlayImage(item, pageNum) {
      if(!item.overlay) return;
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      const overlayImg = document.createElement('img');
      overlayImg.src = item.overlay;
      overlayImg.className = 'overlay';
      overlayImg.dataset.id = item.id;
      overlayImg.style.position = 'absolute';
      overlayImg.style.top = '0';
      overlayImg.style.left = '0';
      overlayImg.style.width = '100%';
      overlayImg.style.height = '100%';
      overlayImg.style.zIndex = item.zIndex;
      workerContainer.appendChild(overlayImg);
    }

    function removeOverlayImage(item, pageNum) {
      const workerContainer = document.querySelector(`#page${pageNum} .worker-container`);
      const overlay = workerContainer.querySelector(`img.overlay[data-id="${item.id}"]`);
      if(overlay) overlay.remove();
    }

    function checkAllCorrectApplied(pageNum) {
      checkGameComplete(pageNum);
    }

    // ì ìˆ˜ ì €ì¥ ë° ë­í‚¹ ë¡œë“œ
    async function saveScoreAndLoadRanking() {
      const playerData = {
        name: document.getElementById('workerName').value,
        siteName: document.getElementById('siteName').value,
        affiliation: document.getElementById('workerAffiliation').value,
        score: currentScore,
        timestamp: new Date()
      };

      try {
        if (db) {
          // Firestore ì‚¬ìš©
          await saveToFirestore(playerData);
          await loadRankingFromFirestore();
        } else {
          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
          saveToLocalStorage(playerData);
          loadRankingFromLocalStorage();
        }
      } catch (error) {
        console.error('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', error);
        // Firestore ì‹¤íŒ¨ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¡œ fallback
        saveToLocalStorage(playerData);
        loadRankingFromLocalStorage();
      }
    }

    // Firestoreì— ì €ì¥
    async function saveToFirestore(playerData) {
      const weekId = getKoreanWeekId();
      const rankingRef = db.collection('rankings').doc(weekId);
      
      const doc = await rankingRef.get();
      let rankings = [];
      
      if (doc.exists) {
        rankings = doc.data().rankings || [];
      }
      
      // í˜„ì¬ í”Œë ˆì´ì–´ ì ìˆ˜ê°€ ìƒìœ„ 5ëª…ì— ë“¤ì–´ê°€ëŠ”ì§€ í™•ì¸
      rankings.push(playerData);
      rankings.sort((a, b) => b.score - a.score);
      
      if (rankings.length > 5) {
        rankings = rankings.slice(0, 5); // ìƒìœ„ 5ëª…ë§Œ ìœ ì§€
      }
      
      await rankingRef.set({ rankings: rankings });
    }

    // Firestoreì—ì„œ ë­í‚¹ ë¡œë“œ
    async function loadRankingFromFirestore() {
      const weekId = getKoreanWeekId();
      const rankingRef = db.collection('rankings').doc(weekId);
      
      const doc = await rankingRef.get();
      let rankings = [];
      
      if (doc.exists) {
        rankings = doc.data().rankings || [];
      }
      
      displayRanking(rankings);
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    function saveToLocalStorage(playerData) {
      const weekId = getKoreanWeekId();
      const key = `rankings_${weekId}`;
      let rankings = JSON.parse(localStorage.getItem(key) || '[]');
      
      rankings.push(playerData);
      rankings.sort((a, b) => b.score - a.score);
      
      if (rankings.length > 5) {
        rankings = rankings.slice(0, 5); // ìƒìœ„ 5ëª…ë§Œ ìœ ì§€
      }
      
      localStorage.setItem(key, JSON.stringify(rankings));
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë­í‚¹ ë¡œë“œ
    function loadRankingFromLocalStorage() {
      const weekId = getKoreanWeekId();
      const key = `rankings_${weekId}`;
      const rankings = JSON.parse(localStorage.getItem(key) || '[]');
      displayRanking(rankings);
    }

    // í•œêµ­ì‹œê°„ ê¸°ì¤€ ì£¼ì°¨ ID ìƒì„± (ì¼ìš”ì¼ 24ì‹œì— ì´ˆê¸°í™”)
    function getKoreanWeekId() {
      // í•œêµ­ì‹œê°„ (UTC+9) ê³„ì‚°
      const now = new Date();
      const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      // í•´ë‹¹ ì£¼ì˜ ì¼ìš”ì¼ ì°¾ê¸°
      const sunday = new Date(koreanTime);
      sunday.setDate(koreanTime.getDate() - koreanTime.getDay());
      sunday.setHours(0, 0, 0, 0);
      
      const year = sunday.getFullYear();
      const month = String(sunday.getMonth() + 1).padStart(2, '0');
      const day = String(sunday.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }

    // ë­í‚¹ í‘œì‹œ
    function displayRanking(rankings) {
      document.getElementById('ranking-loading').style.display = 'none';
      document.getElementById('ranking-table').style.display = 'table';
      
      const tbody = document.getElementById('ranking-body');
      tbody.innerHTML = '';
      
      for (let i = 0; i < 5; i++) {
        const row = tbody.insertRow();
        const rank = i + 1;
        
        if (i < rankings.length) {
          const ranking = rankings[i];
          row.innerHTML = `
            <td>${rank}</td>
            <td>${ranking.name}</td>
            <td>${ranking.siteName}</td>
            <td>${ranking.affiliation}</td>
            <td>${ranking.score}</td>
          `;
        } else {
          row.innerHTML = `
            <td>${rank}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          `;
        }
      }
    }

    document.getElementById('saveCert').addEventListener('click', function() {
      const certificateBox = document.getElementById('certificate-box');
      html2canvas(certificateBox).then(canvas => {
        const link = document.createElement('a');
        link.download = 'certificate.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    });

    // ì´ˆê¸° ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindNextButtonEvents();
  </script>
</body>
</html>
