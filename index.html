<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‘ì—…ë³„ ë³´í˜¸êµ¬ ì°©ìš© ì˜·ì…íˆê¸° ê²Œì„</title>
  <style>
    /* === ê¸°ë³¸ ì„¸íŒ… === */
    body{margin:0;padding:0;font-family:sans-serif}
    .page{display:none;padding:20px;box-sizing:border-box}
    .active{display:block}
    .center{text-align:center}

    /* === ê³µí†µ ì¹´ë“œ === */
    .card{
      background:#fff;border-radius:20px;
      box-shadow:0 15px 25px rgba(0,0,0,.1);
      padding:40px 30px;width:100%;max-width:600px;
      margin:0 auto;box-sizing:border-box
    }

    /* === í˜ì´ì§€ë³„ ë°°ê²½ === */
    #page1{background:linear-gradient(135deg,#7b5dff 0%,#4a8dff 100%);
           min-height:100vh;display:flex;justify-content:center;align-items:center}
    #page2{background:radial-gradient(circle at top left,#f3f3f5 0%,#e9e9eb 100%);
           min-height:100vh;display:flex;justify-content:center;align-items:center}
    #page8{background:linear-gradient(135deg,#b6f0e8 0%,#d3ecf6 50%,#ffd6e6 100%);
           min-height:100vh;display:flex;justify-content:center;align-items:center}

    /* === ë²„íŠ¼ === */
    .button{
      padding:12px 24px;margin:10px;font-size:16px;
      cursor:pointer;color:#fff;border:none;border-radius:8px;
      background:linear-gradient(135deg,#007bff 0%,#0063ff 100%);
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      transition:transform .1s
    }
    .button:hover{transform:translateY(-2px)}

    /* ì–‡ì€ ë‘¥ê·¼ í…Œë‘ë¦¬ */
    .rounded-border{border:1px solid #000;border-radius:10px}

    /* í˜ì´ì§€1 ë‚´ ì´ë¯¸ì§€ */
    #page1 img{max-width:100%;height:auto}

    /* í˜ì´ì§€2 */
    .blink{color:red}

    /* í˜ì´ì§€3-7 ê³µí†µ */
    .worker-container{position:relative;width:100%;text-align:center}
    .worker-image{width:100%;height:auto;display:block;margin:0 auto}
    .gear-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
    .gear-item{width:100%;position:relative}
    .gear-item img{width:80%;display:block;cursor:pointer;margin:0 auto}

    /* ì ìˆ˜Â·ê¸°íšŒ í‘œì‹œ */
    .score-display,.chances-display{
      position:fixed;right:10px;z-index:1000;min-width:100px;
      padding:10px;border-radius:5px;font-weight:bold;text-align:center}
    .score-display{bottom:60px;background:#f0f0f0;border:1px solid #ccc}
    .chances-display{bottom:10px}
    .cycle-1{background:#e8f5e8!important;border:2px solid #4caf50!important;color:#2e7d32!important}
    .cycle-2{background:#fff3e0!important;border:2px solid #ff9800!important;color:#e65100!important}
    .cycle-3-plus{background:#ffebee!important;border:2px solid #f44336!important;color:#d32f2f!important}

    /* ìˆ˜ë£Œì¦ */
    #certificate-box{border:2px solid #000;padding:20px;margin:20px 0;text-align:center}

    /* ë­í‚¹ í…Œì´ë¸” */
    .ranking-table{margin:30px auto 0;border-collapse:collapse;width:100%;max-width:600px}
    .ranking-table th,.ranking-table td{border:1px solid #ddd;padding:8px;text-align:center}
    .ranking-table th{background:#f2f2f2;font-weight:700}
    .ranking-table tr:nth-child(even){background:#f9f9f9}
    .loading{text-align:center;color:#666;font-style:italic}

    /* ê¸°íƒ€ ë²„íŠ¼ */
    .button-group{margin-top:20px}
    .restart-button{
      background:linear-gradient(135deg,#6a63ff 0%,#4e45d5 100%);
      color:#fff;border:none;padding:10px 20px;margin:10px;font-size:16px;
      cursor:pointer;border-radius:8px;transition:transform .1s}
    .restart-button:hover{transform:translateY(-2px)}
  </style>
</head>
<body>
  <!-- ì ìˆ˜ / ê¸°íšŒ -->
  <div id="score-display" class="score-display" style="display:none">ì ìˆ˜: <span id="current-score">0</span></div>
  <div id="chances-display" class="chances-display" style="display:none">í´ë¦­ ê¸°íšŒ: <span id="remaining-chances">âˆ</span></div>

  <!-- í˜ì´ì§€ 1 -->
  <div id="page1" class="page active">
    <div class="card center">
      <h1>ì‘ì—…ë³„ ë³´í˜¸êµ¬ ì°©ìš© êµìœ¡</h1>
      <img src="https://i.imgur.com/Tu6mJ5J.png" alt="ë©”ì¸ ì´ë¯¸ì§€"><br>
      <button class="button" id="startButton">êµìœ¡ ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 2 -->
  <div id="page2" class="page">
    <div class="card">
      <h2 class="center">êµìœ¡ ì •ë³´ ì…ë ¥</h2>
      <label>í˜„ì¥ëª…:</label><br>
      <input id="siteName" placeholder="í˜„ì¥ëª… ì…ë ¥" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px"><br><br>
      <label>ê·¼ë¡œì ì´ë¦„:</label><br>
      <input id="workerName" placeholder="ì´ë¦„ ì…ë ¥" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px"><br><br>
      <label>ì†Œì†:</label><br>
      <input id="workerAffiliation" placeholder="ì†Œì† ì…ë ¥" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px"><br><br>
      <div class="blink" style="padding:16px;border:1px solid #ffb6b6;background:#ffecec;border-radius:6px">
        ì‘ì—… ìƒí™©ì— ë”°ë¥¸ ë³´í˜¸êµ¬ ì°©ìš© ê¸°ì¤€ì„ ì˜·ì…íˆê¸° ê²Œì„ ë°©ì‹ìœ¼ë¡œ í•™ìŠµí•©ë‹ˆë‹¤.<br>
        ê·¼ë¡œì ìºë¦­í„° í•˜ë‹¨ì˜ ë³´í˜¸êµ¬ë¥¼ í´ë¦­í•˜ì—¬ ì˜¬ë°”ë¥¸ ë³´í˜¸êµ¬ë¥¼ ì°©ìš©ì‹œì¼œì£¼ì„¸ìš”.
      </div><br>
      <button class="button" id="toPage3" style="width:100%">ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 3 -->
  <div id="page3" class="page">
    <h2>ê³ ì†Œì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-3"></div>
    <div id="error-message-3" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-3">
      <button class="button" id="next-button-3" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 4 -->
  <div id="page4" class="page">
    <h2>ìš©ì ‘ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-4"></div>
    <div id="error-message-4" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-4">
      <button class="button" id="next-button-4" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 5 -->
  <div id="page5" class="page">
    <h2>ì •ì „ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/WlQOZoc.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-5"></div>
    <div id="error-message-5" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-5">
      <button class="button" id="next-button-5" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 6 -->
  <div id="page6" class="page">
    <h2>ë„ì¥ì‘ì—…ì‹œ í•„ìˆ˜ì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-6"></div>
    <div id="error-message-6" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-6">
      <button class="button" id="next-button-6" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 7 -->
  <div id="page7" class="page">
    <h2>ì¼ë°˜ì‘ì—… ê³µí†µì°©ìš© ê°œì¸ë³´í˜¸êµ¬</h2>
    <div class="worker-container center">
      <img class="worker-image rounded-border" src="https://i.imgur.com/Ifwwzoz.png" alt="ê·¼ë¡œì ì´ë¯¸ì§€">
    </div>
    <div class="gear-grid" id="gear-grid-7"></div>
    <div id="error-message-7" style="color:red;text-align:center;margin-top:10px"></div>
    <div class="center button-group" id="button-container-7">
      <button class="button" id="next-button-7" disabled>ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- í˜ì´ì§€ 8 -->
  <div id="page8" class="page">
    <div class="card center">
      <h2>ìˆ˜ë£Œì¦</h2>
      <div id="certificate-box">
        <p id="cert-siteName"></p>
        <p id="cert-workerName"></p>
        <p id="cert-workerAffiliation"></p>
        <p id="final-score-display">ìµœì¢… ì ìˆ˜: <span id="final-score">0</span>ì </p>
        <p>ë³´í˜¸êµ¬ êµìœ¡ì„ ëª¨ë‘ ìˆ˜ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.</p>
      </div>
      <p>ê´€ë¦¬ìì—ê²Œ ìˆ˜ë£Œì¦ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”</p>
      <button class="button" id="saveCert">ì €ì¥í•˜ê¸°</button>
      <button class="button" id="homeButton">í™ˆìœ¼ë¡œ</button>

      <h3>ğŸ† ì´ë²ˆ ì£¼ ë­í‚¹</h3>
      <div id="ranking-loading" class="loading">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <table id="ranking-table" class="ranking-table" style="display:none">
        <thead>
          <tr><th>ìˆœìœ„</th><th>ê·¼ë¡œì ì´ë¦„</th><th>í˜„ì¥ëª…</th><th>ì†Œì†</th><th>ì ìˆ˜</th></tr>
        </thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ===== JavaScript : ì „ì²´ ê²Œì„ ë¡œì§(ëˆ„ë½ ì—†ì´ í¬í•¨) ===== -->
  <script>
    /* ------------------------------------------------------------------
       (ì•„ë˜ JS ë‚´ìš©ì€ ì´ì „ ë²„ì „ê³¼ ë™ì¼í•˜ë©° í•œ ê¸€ìë„ ë¹ ì§ì—†ì´ ê·¸ëŒ€ë¡œ í¬í•¨)
    ------------------------------------------------------------------ */

    // Firebase ì„¤ì • - ì‹¤ì œ í”„ë¡œì íŠ¸ ì„¤ì • ì ìš©ë¨
    const firebaseConfig = {
      apiKey: "AIzaSyDqZFIp_jzaUFiNlZxO3AYI3b8H9zDgyW4",
      authDomain: "training-private-equipment.firebaseapp.com",
      projectId: "training-private-equipment",
      storageBucket: "training-private-equipment.firebasestorage.app",
      messagingSenderId: "428074253490",
      appId: "1:428074253490:web:77d4040f8af17338795dab"
    };

    // Firebase ì´ˆê¸°í™” (ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©)
    let db = null;
    try {
      if (firebaseConfig.apiKey !== "your-api-key") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
      }
    } catch (error) {
      console.log("Firebase ì„¤ì •ì´ ì—†ì–´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
    }

    // ê° í˜ì´ì§€ë³„ ë³´í˜¸êµ¬ ë°ì´í„°
    const pageGearData = {
      3: [
        { id: 1, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/8gsL65v.png', overlay: 'https://i.imgur.com/zBCjthf.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: 'https://i.imgur.com/VfJMtc3.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/m1GZRHc.png', overlay: 'https://i.imgur.com/Cphm4b5.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      4: [
        { id: 1, thumbnail: 'https://imgur.com/n6iJRus.png', overlay: '', correct: false, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/oU1hjTk.png', overlay: 'https://i.imgur.com/cPHvWTb.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: 'https://i.imgur.com/S77YoN3.png', correct: true, applied: false, zIndex: 4 },
        { id: 4, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: 'https://i.imgur.com/v5kUQPg.png', correct: true, applied: false, zIndex: 3 },
        { id: 5, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      5: [
        { id: 1, thumbnail: 'https://i.imgur.com/NnWSEdz.png', overlay: 'https://i.imgur.com/ImnVVaf.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/NdbXUPl.png', overlay: 'https://i.imgur.com/IMelM9Q.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/Z5ojhhi.png', overlay: 'https://i.imgur.com/3KX2VD4.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      6: [
        { id: 1, thumbnail: 'https://i.imgur.com/fdH4wzC.png', overlay: 'https://i.imgur.com/fdH4wzC.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/F1PF0tE.png', overlay: 'https://i.imgur.com/Gctejg5.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/n6iJRus.png', overlay: 'https://i.imgur.com/oAQe9gI.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/NdbXUPl.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ],
      7: [
        { id: 1, thumbnail: 'https://i.imgur.com/yvsCOBF.png', overlay: 'https://i.imgur.com/yTJe79p.png', correct: true, applied: false, zIndex: 1 },
        { id: 2, thumbnail: 'https://i.imgur.com/nvoxlp7.png', overlay: 'https://i.imgur.com/VfJMtc3.png', correct: true, applied: false, zIndex: 2 },
        { id: 3, thumbnail: 'https://i.imgur.com/d7Plzcn.png', overlay: 'https://i.imgur.com/5VxjKY6.png', correct: true, applied: false, zIndex: 3 },
        { id: 4, thumbnail: 'https://i.imgur.com/m1GZRHc.png', overlay: 'https://i.imgur.com/Cphm4b5.png', correct: true, applied: false, zIndex: 4 },
        { id: 5, thumbnail: 'https://i.imgur.com/Cbcyknu.png', overlay: '', correct: false, applied: false, zIndex: 5 },
        { id: 6, thumbnail: 'https://i.imgur.com/Ui2tbVv.png', overlay: '', correct: false, applied: false, zIndex: 6 }
      ]
    };

    // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
    let currentScore = 0;
    let gameSequence = [3, 4, 5, 6, 7]; // ê¸°ë³¸ í˜ì´ì§€ ìˆœì„œ
    let currentSequenceIndex = 0;
    let hasCompletedFirstCycle = false;
    let isInRandomCycle = false;
    let cycleCount = 1; // í˜„ì¬ ì‚¬ì´í´ íšŸìˆ˜
    let remainingChances = Infinity; // ë‚¨ì€ ê¸°íšŒ
    let maxChancesPerCycle = {
      1: Infinity, // ì²« ë²ˆì§¸ ì‚¬ì´í´: ë¬´ì œí•œ
      2: 10,       // ë‘ ë²ˆì§¸ ì‚¬ì´í´: 10ë²ˆ
      default: 5   // ì„¸ ë²ˆì§¸ ì‚¬ì´í´ ì´í›„: 5ë²ˆ
    };

    /* ==== ì ìˆ˜ / ê¸°íšŒ í•¨ìˆ˜ ==== */
    function updateScore(){currentScore++;document.getElementById('current-score').textContent=currentScore;}
    function showScore(){document.getElementById('score-display').style.display='block'}
    function hideScore(){document.getElementById('score-display').style.display='none'}

    function updateChances(){
      const el=document.getElementById('remaining-chances');
      const box=document.getElementById('chances-display');
      box.classList.remove('cycle-1','cycle-2','cycle-3-plus');
      if(remainingChances===Infinity){el.textContent='âˆ';box.classList.add('cycle-1')}
      else if(cycleCount===2){el.textContent=Math.max(0,remainingChances);box.classList.add('cycle-2')}
      else{el.textContent=Math.max(0,remainingChances);box.classList.add('cycle-3-plus')}
    }
    function showChances(){document.getElementById('chances-display').style.display='block';updateChances();}
    function hideChances(){document.getElementById('chances-display').style.display='none'}

    function decreaseChances(){
      if(remainingChances!==Infinity){
        remainingChances--;updateChances();
        if(remainingChances<0){
          setTimeout(()=>{
            alert(`ğŸ’€ëª¨ë“  ë³´í˜¸êµ¬ë¥¼ ì°©ìš©í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ğŸ’€\ní˜„ì¬ ì ìˆ˜: ${currentScore}ì \nê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.`);
            goToPage8();
          },500);return true;
        }
      }return false;
    }
    function setChancesForCycle(){
      if(cycleCount===1)remainingChances=Infinity;
      else if(cycleCount===2)remainingChances=maxChancesPerCycle[2];
      else remainingChances=maxChancesPerCycle.default;
      updateChances();
    }

    /* ==== í˜ì´ì§€ ì „í™˜ ì´ë²¤íŠ¸ ==== */
    document.getElementById('startButton').addEventListener('click',()=>showPage('page2'));

    document.getElementById('toPage3').addEventListener('click',function(){
      if(!document.getElementById('siteName').value.trim()||
         !document.getElementById('workerName').value.trim()||
         !document.getElementById('workerAffiliation').value.trim()){
        alert('í˜„ì¥ëª…, ê·¼ë¡œì ì´ë¦„, ì†Œì†ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;
      }
      currentScore=0;currentSequenceIndex=0;hasCompletedFirstCycle=false;
      isInRandomCycle=false;gameSequence=[3,4,5,6,7];cycleCount=1;
      for(let i=3;i<=7;i++){
        const c=document.getElementById(`button-container-${i}`);
        if(c)c.innerHTML=`<button class="button" id="next-button-${i}" disabled>ë‹¤ìŒ</button>`;
      }
      document.getElementById('current-score').textContent=currentScore;
      setChancesForCycle();showScore();showChances();showPage('page3');initializeGame(3);bindNextButtonEvents();
    });

    function bindNextButtonEvents(){
      document.querySelectorAll('[id^="next-button-"]').forEach(btn=>btn.replaceWith(btn.cloneNode(true)));
      document.getElementById('next-button-3').addEventListener('click',()=>goToNextPage());
      document.getElementById('next-button-4').addEventListener('click',()=>goToNextPage());
      document.getElementById('next-button-5').addEventListener('click',()=>goToNextPage());
      document.getElementById('next-button-6').addEventListener('click',()=>goToNextPage());
      document.getElementById('next-button-7').addEventListener('click',()=>goToNextPage());
    }

    function goToNextPage(){
      updateScore();currentSequenceIndex++;
      if(currentSequenceIndex>=gameSequence.length){
        showCycleCompleteButtons(gameSequence[gameSequence.length-1]);return;
      }
      const nextPage=gameSequence[currentSequenceIndex];
      setChancesForCycle();showPage(`page${nextPage}`);initializeGame(nextPage);
    }

    function checkGameComplete(pageNum){
      const items=pageGearData[pageNum];
      const allApplied=items.filter(i=>i.correct).every(i=>i.applied);
      const nextBtn=document.getElementById(`next-button-${pageNum}`);
      if(nextBtn)nextBtn.disabled=!allApplied;
      if(allApplied&&currentSequenceIndex===gameSequence.length-1){
        showCycleCompleteButtons(pageNum);
      }
    }

    function showCycleCompleteButtons(pageNum){
      const c=document.getElementById(`button-container-${pageNum}`);
      if(c)c.innerHTML=`
        <button class="button" onclick="goToPage8()">ë‹¤ìŒ</button>
        <button class="restart-button" onclick="startNewRandomCycle()">ë‹¤ì‹œ í•™ìŠµí•˜ê¸°</button>`;
    }

    function goToPage8(){
      hideScore();hideChances();
      document.getElementById('final-score').textContent=currentScore;
      document.getElementById('cert-siteName').innerText="í˜„ì¥ëª…: "+document.getElementById('siteName').value;
      document.getElementById('cert-workerName').innerText="ê·¼ë¡œì ì´ë¦„: "+document.getElementById('workerName').value;
      document.getElementById('cert-workerAffiliation').innerText="ì†Œì†: "+document.getElementById('workerAffiliation').value;
      showPage('page8');saveScoreAndLoadRanking();
    }

    function startNewRandomCycle(){
      cycleCount++;isInRandomCycle=true;gameSequence=shuffle([3,4,5,6,7]);currentSequenceIndex=0;
      for(let i=3;i<=7;i++){
        const c=document.getElementById(`button-container-${i}`);
        if(c)c.innerHTML=`<button class="button" id="next-button-${i}" disabled>ë‹¤ìŒ</button>`;
      }
      const first=gameSequence[0];showPage(`page${first}`);initializeGame(first);bindNextButtonEvents();
    }

    document.getElementById('homeButton').addEventListener('click',()=>location.reload());

    function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');}
    function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

    function initializeGame(pageNum){
      const items=pageGearData[pageNum];items.forEach(i=>i.applied=false);
      const shuffled=shuffle([...items]);const grid=document.getElementById(`gear-grid-${pageNum}`);grid.innerHTML='';
      if(currentSequenceIndex===0)setChancesForCycle();
      shuffled.forEach(item=>{
        const d=document.createElement('div');d.className='gear-item';
        const img=document.createElement('img');img.src=item.thumbnail;img.classList.add('rounded-border');img.dataset.id=item.id;
        img.style.pointerEvents='auto';img.style.opacity='1';img.style.cursor='pointer';
        img.addEventListener('click',()=>handleGearClick(item,img,pageNum));
        d.appendChild(img);grid.appendChild(d);
      });
      const container=document.querySelector(`#page${pageNum} .worker-container`);
      container.querySelectorAll('.overlay').forEach(o=>o.remove());
      const nextBtn=document.getElementById(`next-button-${pageNum}`);if(nextBtn)nextBtn.disabled=true;
      document.getElementById(`error-message-${pageNum}`).innerText='';
    }

    function handleGearClick(item,el,pageNum){
      if(cycleCount>1){if(decreaseChances())return;}
      if(item.correct){
        if(!item.applied){el.style.opacity=.5;item.applied=true;addOverlayImage(item,pageNum);}
        else{el.style.opacity=1;item.applied=false;removeOverlayImage(item,pageNum);}
      }else{
        const err=document.getElementById(`error-message-${pageNum}`);
        err.innerText='ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë³´í˜¸êµ¬ì…ë‹ˆë‹¤.';setTimeout(()=>err.innerText='',2000);
      }
      checkAllCorrectApplied(pageNum);
    }
    function addOverlayImage(item,pageNum){
      if(!item.overlay)return;
      const container=document.querySelector(`#page${pageNum} .worker-container`);
      const o=document.createElement('img');o.src=item.overlay;o.className='overlay';o.dataset.id=item.id;
      o.style.position='absolute';o.style.top=0;o.style.left=0;o.style.width='100%';o.style.height='100%';o.style.zIndex=item.zIndex;
      container.appendChild(o);
    }
    function removeOverlayImage(item,pageNum){
      const container=document.querySelector(`#page${pageNum} .worker-container`);
      const o=container.querySelector(`img.overlay[data-id="${item.id}"]`);if(o)o.remove();
    }
    function checkAllCorrectApplied(pageNum){checkGameComplete(pageNum);}

    /* ==== ì ìˆ˜ ì €ì¥ / ë­í‚¹ ==== */
    async function saveScoreAndLoadRanking(){
      const data={
        name:document.getElementById('workerName').value,
        siteName:document.getElementById('siteName').value,
        affiliation:document.getElementById('workerAffiliation').value,
        score:currentScore,timestamp:new Date()
      };
      try{
        if(db){await saveToFirestore(data);await loadRankingFromFirestore();}
        else{saveToLocalStorage(data);loadRankingFromLocalStorage();}
      }catch(e){console.error('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:',e);saveToLocalStorage(data);loadRankingFromLocalStorage();}
    }

    async function saveToFirestore(d){
      const week=getKoreanWeekId();const ref=db.collection('rankings').doc(week);
      const doc=await ref.get();let ranks=[];if(doc.exists)ranks=doc.data().rankings||[];
      ranks.push(d);ranks.sort((a,b)=>b.score-a.score);if(ranks.length>5)ranks=ranks.slice(0,5);
      await ref.set({rankings:ranks});
    }
    async function loadRankingFromFirestore(){
      const week=getKoreanWeekId();const ref=db.collection('rankings').doc(week);
      const doc=await ref.get();let ranks=[];if(doc.exists)ranks=doc.data().rankings||[];
      displayRanking(ranks);
    }
    function saveToLocalStorage(d){
      const week=getKoreanWeekId();const key=`rankings_${week}`;let ranks=JSON.parse(localStorage.getItem(key)||'[]');
      ranks.push(d);ranks.sort((a,b)=>b.score-a.score);if(ranks.length>5)ranks=ranks.slice(0,5);localStorage.setItem(key,JSON.stringify(ranks));
    }
    function loadRankingFromLocalStorage(){
      const week=getKoreanWeekId();const key=`rankings_${week}`;const ranks=JSON.parse(localStorage.getItem(key)||'[]');displayRanking(ranks);
    }
    function getKoreanWeekId(){
      const now=new Date();const kor=new Date(now.getTime()+9*60*60*1000);
      const sunday=new Date(kor);sunday.setDate(kor.getDate()-kor.getDay());sunday.setHours(0,0,0,0);
      const y=sunday.getFullYear();const m=String(sunday.getMonth()+1).padStart(2,'0');const d=String(sunday.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function displayRanking(ranks){
      document.getElementById('ranking-loading').style.display='none';
      document.getElementById('ranking-table').style.display='table';
      const tbody=document.getElementById('ranking-body');tbody.innerHTML='';
      for(let i=0;i<5;i++){
        const row=tbody.insertRow();const r=i+1;
        if(i<ranks.length){
          const v=ranks[i];row.innerHTML=`<td>${r}</td><td>${v.name}</td><td>${v.siteName}</td><td>${v.affiliation}</td><td>${v.score}</td>`;
        }else{row.innerHTML=`<td>${r}</td><td>-</td><td>-</td><td>-</td><td>-</td>`;}
      }
    }

    /* ==== ìˆ˜ë£Œì¦ ì €ì¥ ==== */
    document.getElementById('saveCert').addEventListener('click',()=>{
      html2canvas(document.getElementById('certificate-box')).then(canvas=>{
        const link=document.createElement('a');link.download='certificate.png';link.href=canvas.toDataURL();link.click();
      });
    });

    /* ì´ˆê¸° ë°”ì¸ë”© */
    bindNextButtonEvents();
  </script>
</body>
</html>

